<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Viable Edge â€” Command Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark-dimmed.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/material-darker.min.css">
  <style>
    /* --- Reset & Base --- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-base: #0f0f11;
      --bg-surface: rgba(10,10,10,0.75);
      --bg-elevated: rgba(20,20,23,0.80);
      --bg-hover: rgba(26,26,31,0.85);
      --bg-glass: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.06);
      --border-glass: rgba(255,255,255,0.06);
      --border-light: rgba(255,255,255,0.10);
      --border-hover: rgba(255,255,255,0.20);
      --text: #f5f5f7;
      --text-muted: rgba(255,255,255,0.50);
      --text-dim: rgba(255,255,255,0.40);
      --text-disabled: rgba(255,255,255,0.30);
      --accent: #f97316;
      --accent-dim: rgba(249,115,22,0.15);
      --accent-glow: rgba(249,115,22,0.25);
      --gradient-accent: linear-gradient(135deg, #7c5cff 0%, #06b6d4 100%);
      --gradient-accent-subtle: linear-gradient(135deg, rgba(124,92,255,0.15) 0%, rgba(6,182,212,0.15) 100%);
      --green: #10b981;
      --green-dim: rgba(16,185,129,0.15);
      --amber: #f59e0b;
      --amber-dim: rgba(245,158,11,0.15);
      --red: #ef4444;
      --red-dim: rgba(239,68,68,0.15);
      --cyan: #06b6d4;
      --blue: #3b82f6;
      --pink: #ec4899;
      --purple: #7c5cff;
      --user-bg: rgba(249,115,22,0.08);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.2);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.4), 0 4px 8px rgba(0,0,0,0.3);
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      --brand-gradient: linear-gradient(135deg, #f97316 0%, #8b5cf6 33%, #3b82f6 66%, #10b981 100%);
      --font-mono: 'IBM Plex Mono', 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-heading: 'Poppins', var(--font-sans);
    }

    body {
      font-family: var(--font-sans);
      font-size: 13px;
      line-height: 1.5;
      background: var(--bg-base);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    /* Ambient gradient glow behind glass panels */
    body::before {
      content: '';
      position: fixed;
      top: -40%;
      left: -20%;
      width: 70%;
      height: 80%;
      background: radial-gradient(ellipse at center, rgba(124,92,255,0.08) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    .app::after {
      content: '';
      position: fixed;
      bottom: -30%;
      right: -10%;
      width: 60%;
      height: 70%;
      background: radial-gradient(ellipse at center, rgba(6,182,212,0.06) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      opacity: 0.03;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 9999;
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation: none !important; transition: none !important; }
      body::after { display: none; }
      .sidebar, .context-panel, .session-tabs, .input-bar { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; }
    }

    /* --- Layout --- */
    .app {
      display: grid;
      grid-template-columns: 240px 1fr 260px;
      grid-template-rows: 1fr auto;
      height: 100vh;
      position: relative;
    }

    .app > .brand-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--brand-gradient);
      z-index: 200;
      box-shadow: 0 2px 16px rgba(124,92,255,0.2), 0 1px 4px rgba(249,115,22,0.15);
    }

    /* --- Left Sidebar: Agents --- */
    .sidebar {
      grid-row: 1 / 3;
      background: rgba(12,12,15,0.82);
      backdrop-filter: blur(20px) saturate(1.2);
      -webkit-backdrop-filter: blur(20px) saturate(1.2);
      border-right: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 10;
      box-shadow: 4px 0 24px rgba(0,0,0,0.3);
    }

    .sidebar-header {
      padding: 18px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: linear-gradient(180deg, rgba(124,92,255,0.06) 0%, transparent 100%);
    }

    .sidebar-logo {
      height: 28px;
      width: auto;
      display: block;
    }

    .sidebar-subtitle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      font-family: var(--font-heading);
    }

    .ws-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--red);
      flex-shrink: 0;
    }

    .ws-dot.connected {
      background: var(--green);
      box-shadow: 0 0 6px var(--green);
    }

    .sidebar-section {
      padding: 12px 16px 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
    }

    .agent-list {
      overflow-y: auto;
      padding: 4px 8px;
    }

    .agent-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.25s var(--ease-out-expo), transform 0.25s var(--ease-out-expo), box-shadow 0.25s var(--ease-out-expo), border-color 0.15s;
      border-left: 3px solid transparent;
    }

    .agent-card:hover { background: var(--bg-hover); transform: translateY(-2px) translateX(2px); box-shadow: var(--shadow-sm); }
    .agent-card.active { background: var(--accent-dim); border-left-color: var(--accent); }

    .agent-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .agent-info {
      flex: 1;
      min-width: 0;
    }

    .agent-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: var(--font-heading);
    }

    .agent-desc {
      font-size: 10px;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .agent-hotkey {
      font-size: 10px;
      color: var(--text-dim);
      background: var(--bg-base);
      padding: 1px 5px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    /* Team groups */
    .team-group { margin-bottom: 2px; }

    .team-group summary {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px 6px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
      cursor: pointer;
      list-style: none;
      user-select: none;
      transition: color 0.2s;
    }

    .team-group summary::-webkit-details-marker { display: none; }
    .team-group summary::before {
      content: '\25B6';
      font-size: 7px;
      transition: transform 0.25s var(--ease-out-expo);
      display: inline-block;
    }

    .team-group[open] summary::before { transform: rotate(90deg); }
    .team-group summary:hover { color: var(--text-muted); }

    .team-group summary .team-icon { font-size: 12px; }
    .team-group summary .team-count {
      margin-left: auto;
      font-size: 9px;
      color: var(--text-disabled);
      background: var(--bg-base);
      padding: 1px 5px;
      border-radius: 3px;
    }

    @keyframes teamSlideIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .team-group .agent-card { animation: teamSlideIn 0.2s var(--ease-out-expo) both; }

    /* Live session cards in sidebar */
    .live-cards { padding: 4px 8px; }

    .live-card {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      margin-bottom: 4px;
      border-radius: var(--radius-sm);
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.2s var(--ease-out-expo);
      position: relative;
    }

    .live-card:hover { background: var(--bg-hover); transform: translateY(-1px); box-shadow: var(--shadow-sm); }

    .live-card .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .live-card .live-dot.running { background: var(--green); box-shadow: 0 0 6px var(--green); animation: pulse 1.5s infinite; }
    .live-card .live-dot.starting { background: var(--amber); animation: pulse 1.5s infinite; }
    .live-card .live-dot.waiting_permission { background: var(--amber); }
    .live-card .live-dot.idle { background: var(--blue); }
    .live-card .live-dot.completed { background: var(--text-dim); }
    .live-card .live-dot.error { background: var(--red); }

    .live-card-info { flex: 1; min-width: 0; }
    .live-card-name { font-size: 11px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .live-card-detail { font-size: 9px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .live-card .live-dismiss {
      font-size: 12px;
      color: var(--text-dim);
      cursor: pointer;
      padding: 0 2px;
      line-height: 1;
      opacity: 0;
      transition: opacity 0.15s, color 0.15s;
    }

    .live-card:hover .live-dismiss { opacity: 1; }
    .live-card .live-dismiss:hover { color: var(--red); }

    /* Sessions in sidebar */
    .sessions-section {
      border-top: 1px solid var(--border);
      flex-shrink: 0;
      max-height: 200px;
      overflow-y: auto;
    }

    .session-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      cursor: pointer;
      font-size: 11px;
      transition: background 0.15s;
    }

    .session-item:hover { background: var(--bg-hover); }
    .session-item.active { background: rgba(249,115,22,0.06); border-left: 2px solid var(--accent); }

    .session-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .session-dot.running { background: var(--green); box-shadow: 0 0 4px var(--green); }
    .session-dot.starting { background: var(--amber); animation: pulse 1.5s infinite; }
    .session-dot.waiting_permission { background: var(--amber); }
    .session-dot.completed { background: var(--text-dim); }
    .session-dot.error { background: var(--red); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .session-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-muted);
    }

    /* --- Center: Chat --- */
    .main {
      grid-column: 2;
      grid-row: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    .session-tabs {
      display: flex;
      gap: 4px;
      padding: 8px 12px;
      background: rgba(12,12,15,0.70);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      overflow-x: auto;
      min-height: 40px;
      align-items: center;
    }

    .session-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      font-size: 11px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-muted);
      white-space: nowrap;
      transition: background 0.15s, color 0.15s;
    }

    .session-tab:hover { background: var(--bg-hover); color: var(--text); }
    .session-tab.active { background: var(--gradient-accent-subtle); color: var(--text); border: 1px solid rgba(124,92,255,0.2); }

    .session-tab .close-btn {
      font-size: 14px;
      color: var(--text-dim);
      cursor: pointer;
      padding: 0 2px;
      line-height: 1;
    }

    .session-tab .close-btn:hover { color: var(--red); }

    .no-tabs-hint {
      font-size: 11px;
      color: var(--text-dim);
      padding: 0 4px;
    }

    /* Panel switcher */
    .panel-switcher {
      display: flex;
      gap: 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(12,12,15,0.75);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .panel-tab {
      flex: 1;
      padding: 8px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      cursor: pointer;
      text-align: center;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-color 0.3s var(--ease-out-expo);
      font-family: var(--font-heading);
      user-select: none;
    }

    .panel-tab:hover { color: var(--text-muted); }
    .panel-tab.active { color: var(--text); border-bottom-color: var(--purple); }

    /* Chat area */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
    }

    .chat-area::after {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.03) 1px, transparent 0);
      background-size: 32px 32px;
      pointer-events: none;
      z-index: 0;
    }

    .chat-area > * {
      position: relative;
      z-index: 1;
    }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      gap: 16px;
    }

    .empty-state h2 {
      font-size: 24px;
      font-weight: 700;
      background: var(--gradient-accent);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: var(--font-heading);
    }

    .empty-state .brand-dots {
      display: flex;
      gap: 6px;
    }

    .empty-state .brand-dots span {
      width: 8px;
      height: 8px;
      border-radius: 2px;
      box-shadow: 0 0 8px currentColor;
    }

    .empty-state p {
      font-size: 13px;
      max-width: 440px;
      text-align: center;
      line-height: 1.6;
    }

    .quick-agents {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .quick-agent-btn {
      padding: 8px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border-light);
      background: var(--bg-glass);
      color: var(--text);
      cursor: pointer;
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 500;
    }

    /* Messages */
    .message {
      max-width: 85%;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      align-self: flex-end;
      background: rgba(124,92,255,0.10);
      border: 1px solid rgba(124,92,255,0.20);
      padding: 12px 16px;
      border-radius: var(--radius) var(--radius) 4px var(--radius);
      color: var(--text);
      white-space: pre-wrap;
      box-shadow: var(--shadow-sm);
    }

    .message.assistant {
      align-self: flex-start;
      max-width: 90%;
    }

    .msg-agent-label {
      font-size: 10px;
      font-weight: 600;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .msg-content {
      background: rgba(20,20,23,0.85);
      padding: 14px 18px;
      border-radius: 4px var(--radius) var(--radius) var(--radius);
      border: 1px solid rgba(255,255,255,0.04);
      box-shadow: var(--shadow-sm);
    }

    /* Markdown */
    .msg-content h1, .msg-content h2, .msg-content h3 { margin: 12px 0 6px; color: var(--text); font-family: var(--font-heading); }
    .msg-content h1 { font-size: 16px; }
    .msg-content h2 { font-size: 15px; }
    .msg-content h3 { font-size: 14px; }
    .msg-content p { margin: 6px 0; }
    .msg-content ul, .msg-content ol { margin: 6px 0; padding-left: 20px; }
    .msg-content li { margin: 2px 0; }

    .msg-content code {
      background: var(--bg-base);
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 12px;
      font-family: var(--font-mono);
    }

    .msg-content pre {
      background: var(--bg-base);
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      overflow-x: auto;
      margin: 8px 0;
      border: 1px solid var(--border);
    }

    .msg-content pre code { background: none; padding: 0; font-size: 12px; }
    .msg-content a { color: var(--accent); }

    .msg-content blockquote {
      border-left: 3px solid var(--border-light);
      padding-left: 12px;
      margin: 8px 0;
      color: var(--text-muted);
    }

    .msg-content table { border-collapse: collapse; margin: 8px 0; font-size: 12px; }
    .msg-content th, .msg-content td { border: 1px solid var(--border); padding: 4px 8px; }
    .msg-content th { background: var(--bg-base); }

    .streaming-cursor::after {
      content: '\2588';
      animation: blink 0.8s infinite;
      color: var(--accent);
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    /* Tool cards */
    .tool-card {
      margin: 6px 0;
      border: 1px solid var(--border-glass);
      border-left: 3px solid var(--purple);
      border-radius: var(--radius-sm);
      overflow: hidden;
      font-size: 12px;
      background: var(--bg-glass);
      box-shadow: var(--shadow-sm);
    }

    .tool-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(15,15,17,0.6);
      cursor: pointer;
      user-select: none;
    }

    .tool-header:hover { background: var(--bg-hover); }

    .tool-icon { font-size: 11px; width: 18px; text-align: center; }
    .tool-name { font-weight: 600; color: var(--text-muted); }

    .tool-summary {
      flex: 1;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tool-status {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 3px;
      font-weight: 600;
    }

    .tool-status.running { background: var(--amber-dim); color: var(--amber); }
    .tool-status.done { background: var(--green-dim); color: var(--green); }
    .tool-status.error { background: var(--red-dim); color: var(--red); }

    .tool-body {
      display: none;
      padding: 8px 10px;
      background: var(--bg-surface);
      border-top: 1px solid var(--border);
    }

    .tool-body.expanded { display: block; }

    .tool-body pre {
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
      color: var(--text-muted);
      max-height: 200px;
      overflow-y: auto;
    }

    .tool-result-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-dim);
      margin-top: 6px;
      margin-bottom: 2px;
    }

    /* Permission cards */
    .permission-card {
      margin: 8px 0;
      border: 1px solid var(--amber);
      border-radius: var(--radius-lg);
      overflow: hidden;
      animation: fadeIn 0.3s var(--ease-out-expo);
      background: var(--bg-glass);
      box-shadow: 0 0 24px rgba(245,158,11,0.08), var(--shadow-md);
    }

    .permission-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--amber-dim);
      font-size: 12px;
      font-weight: 600;
      color: var(--amber);
    }

    .permission-body {
      padding: 10px 12px;
      background: var(--bg-elevated);
    }

    .permission-body pre {
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
      color: var(--text-muted);
      margin: 6px 0;
    }

    .permission-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-allow, .btn-deny {
      padding: 8px 20px;
      border-radius: var(--radius-sm);
      border: none;
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.25s var(--ease-out-expo), transform 0.25s var(--ease-out-expo), box-shadow 0.25s var(--ease-out-expo);
    }

    .btn-allow { background: var(--green); color: #000; box-shadow: 0 2px 8px rgba(16,185,129,0.3); }
    .btn-deny { background: var(--red-dim); color: var(--red); border: 1px solid rgba(239,68,68,0.2); }
    .btn-allow:hover, .btn-deny:hover { opacity: 0.85; }
    .btn-allow:disabled, .btn-deny:disabled { opacity: 0.4; cursor: not-allowed; }

    /* AskUserQuestion cards */
    .ask-card {
      margin: 8px 0;
      border: 1px solid rgba(124,92,255,0.3);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--bg-glass);
      box-shadow: var(--shadow-md);
    }

    .ask-header {
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(124,92,255,0.12) 0%, rgba(6,182,212,0.08) 100%);
      font-size: 11px;
      font-weight: 600;
      color: var(--purple);
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-heading);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .ask-header::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 1.5s infinite;
      flex-shrink: 0;
    }

    .ask-body { padding: 14px 16px; background: var(--bg-elevated); }
    .ask-question { font-size: 15px; font-weight: 500; color: var(--text); margin-bottom: 12px; line-height: 1.5; }
    .ask-options { display: flex; flex-direction: column; gap: 8px; }

    .ask-option {
      padding: 14px 16px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s, transform 0.2s, box-shadow 0.2s;
      background: var(--bg-surface);
      position: relative;
      overflow: hidden;
    }

    .ask-option::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--accent);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .ask-option:hover {
      border-color: rgba(249,115,22,0.3);
      background: var(--bg-hover);
      transform: translateY(-1px);
    }

    .ask-option:hover::before { opacity: 1; }

    .ask-option.selected {
      border-color: var(--accent);
      background: var(--accent-dim);
    }

    .ask-option.selected::before { opacity: 1; }

    .ask-option-label { font-size: 14px; font-weight: 600; color: var(--text); }
    .ask-option-desc { font-size: 13px; color: var(--text-muted); margin-top: 3px; line-height: 1.4; }

    .ask-submit {
      margin-top: 12px;
      padding: 10px 24px;
      border-radius: var(--radius);
      border: none;
      background: var(--gradient-accent);
      color: #fff;
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.25s var(--ease-out-expo), box-shadow 0.25s var(--ease-out-expo), transform 0.25s var(--ease-out-expo);
      box-shadow: 0 2px 12px rgba(124,92,255,0.25);
    }

    .ask-submit:hover { opacity: 0.9; box-shadow: 0 4px 20px rgba(124,92,255,0.4); transform: translateY(-1px); }
    .ask-submit:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; }

    /* Quick-reply buttons (auto-detected numbered options) */
    .quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .quick-replies.qr-scrollable {
      max-height: 320px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    .qr-btn {
      flex: 1 1 calc(50% - 4px);
      min-width: 180px;
      padding: 12px 14px;
      border: 1px solid rgba(124,92,255,0.25);
      border-radius: var(--radius);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s, transform 0.2s, box-shadow 0.2s;
      background: var(--bg-surface);
      text-align: left;
      font-family: var(--font-sans);
      color: var(--text);
      position: relative;
      overflow: hidden;
    }

    .qr-btn::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--purple);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .qr-btn:hover {
      border-color: rgba(124,92,255,0.5);
      background: var(--bg-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(124,92,255,0.15);
    }

    .qr-btn:hover::before { opacity: 1; }

    .qr-label { font-size: 13px; font-weight: 600; line-height: 1.3; }
    .qr-desc { font-size: 12px; color: var(--text-muted); margin-top: 3px; line-height: 1.4; }

    .qr-btn.sent {
      opacity: 0.4;
      pointer-events: none;
      border-color: var(--border);
    }

    .qr-btn.sent-active {
      opacity: 0.7;
      pointer-events: none;
      border-color: var(--green);
      background: var(--green-dim);
    }

    .qr-btn.sent-active::after {
      content: 'Sent';
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 10px;
      font-weight: 600;
      color: var(--green);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    @media (max-width: 600px) {
      .qr-btn { flex: 1 1 100%; min-width: 0; }
      .quick-replies.qr-scrollable { grid-template-columns: 1fr; }
    }

    /* Session result */
    .result-card {
      margin: 8px 0;
      border: 1px solid rgba(124,92,255,0.15);
      border-radius: var(--radius);
      padding: 12px 16px;
      background: var(--gradient-accent-subtle);
      box-shadow: var(--shadow-sm);
    }

    .result-card.error { border-color: var(--red-dim); }
    .result-header { font-size: 12px; font-weight: 600; margin-bottom: 6px; }

    .result-stats {
      display: flex;
      gap: 16px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .result-stat span { color: var(--text); font-weight: 600; }

    /* --- Input Bar --- */
    .input-bar {
      grid-column: 2;
      display: flex;
      align-items: flex-end;
      gap: 10px;
      padding: 14px 20px;
      background: rgba(12,12,15,0.85);
      backdrop-filter: blur(20px) saturate(1.2);
      -webkit-backdrop-filter: blur(20px) saturate(1.2);
      border-top: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 -4px 24px rgba(0,0,0,0.2);
      z-index: 10;
    }

    .input-bar textarea {
      flex: 1;
      background: var(--bg-elevated);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 10px 14px;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.4;
      resize: none;
      min-height: 42px;
      max-height: 120px;
      outline: none;
      transition: border-color 0.25s var(--ease-out-expo), box-shadow 0.25s var(--ease-out-expo);
    }

    .input-bar textarea:focus { border-color: var(--purple); box-shadow: 0 0 0 2px rgba(124,92,255,0.2); }
    .input-bar textarea::placeholder { color: var(--text-dim); }

    .input-bar button {
      padding: 10px 20px;
      border-radius: var(--radius);
      border: none;
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.25s var(--ease-out-expo), box-shadow 0.25s var(--ease-out-expo), transform 0.25s var(--ease-out-expo);
      white-space: nowrap;
    }

    .btn-send:hover:not(:disabled) { box-shadow: 0 4px 20px rgba(124,92,255,0.4), 0 0 40px rgba(6,182,212,0.15); transform: translateY(-2px); }

    .btn-send { background: var(--gradient-accent); color: #fff; box-shadow: 0 2px 12px rgba(124,92,255,0.25); }
    .btn-stop { background: var(--red-dim); color: var(--red); }
    .btn-send:hover, .btn-stop:hover { opacity: 0.85; }
    .btn-send:disabled, .btn-stop:disabled { opacity: 0.4; cursor: not-allowed; }

    /* --- Right Sidebar: Context --- */
    .context-panel {
      grid-column: 3;
      grid-row: 1 / 3;
      background: rgba(12,12,15,0.82);
      backdrop-filter: blur(20px) saturate(1.2);
      -webkit-backdrop-filter: blur(20px) saturate(1.2);
      border-left: 1px solid rgba(255,255,255,0.08);
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      z-index: 10;
      box-shadow: -4px 0 24px rgba(0,0,0,0.3);
    }

    .ctx-section {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: var(--radius);
      padding: 12px;
    }

    .ctx-section h3 {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-family: var(--font-heading);
    }

    .ctx-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 3px 0;
      font-size: 11px;
    }

    .ctx-item-label { color: var(--text-muted); }

    .ctx-badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 3px;
      font-weight: 600;
    }

    .ctx-badge.fresh { background: var(--green-dim); color: var(--green); }
    .ctx-badge.stale { background: var(--amber-dim); color: var(--amber); }
    .ctx-badge.old { background: var(--red-dim); color: var(--red); }
    .ctx-badge.never { background: var(--bg-base); color: var(--text-dim); }
    .ctx-badge.yes { background: var(--green-dim); color: var(--green); }
    .ctx-badge.no { background: var(--red-dim); color: var(--red); }

    .ctx-stat {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      font-size: 11px;
      color: var(--text-muted);
    }

    .ctx-stat-value { color: var(--text); font-weight: 600; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.10); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.18); }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 80px;
      right: 280px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 100;
    }

    .toast {
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 3s;
      animation-fill-mode: forwards;
    }

    .toast.info { background: var(--bg-elevated); border: 1px solid var(--border-glass); color: var(--text-muted); box-shadow: var(--shadow-md); }
    .toast.success { background: var(--green-dim); border: 1px solid var(--green); color: var(--green); box-shadow: var(--shadow-md); }
    .toast.error { background: var(--red-dim); border: 1px solid var(--red); color: var(--red); box-shadow: var(--shadow-md); }

    @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { to { opacity: 0; } }

    /* --- File Browser --- */
    .file-browser {
      display: none;
      grid-template-columns: 240px 1fr;
      height: 100%;
      overflow: hidden;
    }

    .file-browser.active { display: grid; }

    .file-tree {
      overflow-y: auto;
      border-right: 1px solid var(--border-glass);
      padding: 8px 0;
      background: rgba(10,10,10,0.4);
    }

    .file-tree-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px 4px calc(8px + var(--depth, 0) * 16px);
      font-size: 12px;
      cursor: pointer;
      color: var(--text-muted);
      transition: background 0.15s, color 0.15s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-tree-item:hover { background: var(--bg-hover); color: var(--text); }
    .file-tree-item.active { background: var(--gradient-accent-subtle); color: var(--text); }
    .file-tree-item .tree-icon { font-size: 11px; width: 16px; text-align: center; flex-shrink: 0; }
    .file-tree-item .tree-arrow { font-size: 8px; width: 12px; text-align: center; flex-shrink: 0; transition: transform 0.2s var(--ease-out-expo); }
    .file-tree-item .tree-arrow.open { transform: rotate(90deg); }

    .file-editor {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .file-editor-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-glass);
      background: rgba(10,10,10,0.4);
      font-size: 11px;
    }

    .file-editor-path {
      flex: 1;
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-editor-size { color: var(--text-dim); font-size: 10px; }

    .file-editor-dirty { color: var(--amber); font-size: 10px; font-weight: 600; }

    .btn-save {
      padding: 4px 12px;
      border-radius: var(--radius-sm);
      border: none;
      background: var(--gradient-accent);
      color: #fff;
      font-family: var(--font-sans);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, box-shadow 0.2s, transform 0.2s var(--ease-out-expo);
    }

    .btn-save:hover:not(:disabled) { box-shadow: 0 0 12px rgba(124,92,255,0.3); transform: translateY(-1px); }
    .btn-save:disabled { opacity: 0.4; cursor: not-allowed; }

    .file-editor-content {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .file-editor-content .CodeMirror {
      height: 100%;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.5;
    }

    .file-editor-content textarea.fallback-editor {
      width: 100%;
      height: 100%;
      background: var(--bg-base);
      color: var(--text);
      border: none;
      padding: 12px;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.5;
      resize: none;
      outline: none;
    }

    .file-editor-empty {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      font-size: 13px;
    }

    /* Skeleton shimmer for loading */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-base) 25%, var(--bg-elevated) 50%, var(--bg-base) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
      height: 16px;
      margin: 4px 8px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Quick agent buttons lift */
    .quick-agent-btn {
      transition: border-color 0.25s var(--ease-out-expo), background 0.25s var(--ease-out-expo), transform 0.25s var(--ease-out-expo), box-shadow 0.25s var(--ease-out-expo);
    }

    .quick-agent-btn:hover {
      border-color: var(--purple);
      background: var(--bg-elevated);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="brand-bar"></div>
    <!-- Left Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <img class="sidebar-logo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAABkCAYAAACoy2Z3AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAEv2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSfvu78nIGlkPSdXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQnPz4KPHg6eG1wbWV0YSB4bWxuczp4PSdhZG9iZTpuczptZXRhLyc+CjxyZGY6UkRGIHhtbG5zOnJkZj0naHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyc+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczpBdHRyaWI9J2h0dHA6Ly9ucy5hdHRyaWJ1dGlvbi5jb20vYWRzLzEuMC8nPgogIDxBdHRyaWI6QWRzPgogICA8cmRmOlNlcT4KICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0nUmVzb3VyY2UnPgogICAgIDxBdHRyaWI6Q3JlYXRlZD4yMDI1LTA2LTI2PC9BdHRyaWI6Q3JlYXRlZD4KICAgICA8QXR0cmliOkV4dElkPmZlYTcwMWQ1LTI0ODAtNGUzYy1iZTRmLWUyYTA2ZWY2MTVlOTwvQXR0cmliOkV4dElkPgogICAgIDxBdHRyaWI6RmJJZD41MjUyNjU5MTQxNzk1ODA8L0F0dHJpYjpGYklkPgogICAgIDxBdHRyaWI6VG91Y2hUeXBlPjI8L0F0dHJpYjpUb3VjaFR5cGU+CiAgICA8L3JkZjpsaT4KICAgPC9yZGY6U2VxPgogIDwvQXR0cmliOkFkcz4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PScnCiAgeG1sbnM6ZGM9J2h0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvJz4KICA8ZGM6dGl0bGU+CiAgIDxyZGY6QWx0PgogICAgPHJkZjpsaSB4bWw6bGFuZz0neC1kZWZhdWx0Jz5WRV9QcmltYXJ5X0xvZ29fSFpfV2hpdGVfNDAweDEwMCAtIDE8L3JkZjpsaT4KICAgPC9yZGY6QWx0PgogIDwvZGM6dGl0bGU+CiA8L3JkZjpEZXNjcmlwdGlvbj4K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" alt="The Viable Edge" />
        <div class="sidebar-subtitle">
          <div class="ws-dot" id="wsDot"></div>
          Command Center
        </div>
      </div>

      <div class="agent-list" id="teamList"></div>

      <div class="sessions-section">
        <div class="sidebar-section">Live Sessions</div>
        <div class="live-cards" id="liveCards"></div>
      </div>
    </div>

    <!-- Center: Chat + Files -->
    <div class="main">
      <div class="panel-switcher">
        <div class="panel-tab active" data-panel="chat" onclick="switchPanel('chat')">Chat</div>
        <div class="panel-tab" data-panel="files" onclick="switchPanel('files')">Files</div>
      </div>
      <div class="session-tabs" id="sessionTabs">
        <span class="no-tabs-hint">No active sessions</span>
      </div>
      <div class="chat-area" id="chatArea">
        <div class="empty-state" id="emptyState">
          <h2>Command Center</h2>
          <div class="brand-dots">
            <span style="background:#f97316"></span>
            <span style="background:#8b5cf6"></span>
            <span style="background:#3b82f6"></span>
            <span style="background:#10b981"></span>
          </div>
          <p>Select an agent from the sidebar or use a quick launch below to start an interactive session. Your agents can plan campaigns, analyze performance, create content, and more.</p>
          <div class="quick-agents" id="quickAgents"></div>
        </div>
      </div>
      <div class="file-browser" id="fileBrowser">
        <div class="file-tree" id="fileTree">
          <div class="skeleton"></div><div class="skeleton" style="width:70%"></div><div class="skeleton" style="width:85%"></div>
        </div>
        <div class="file-editor" id="fileEditor">
          <div class="file-editor-empty">Select a file from the tree to edit</div>
        </div>
      </div>
    </div>

    <!-- Input Bar -->
    <div class="input-bar">
      <textarea id="inputText" placeholder="Select an agent to start..." rows="1"></textarea>
      <button class="btn-send" id="btnSend" disabled>Send</button>
      <button class="btn-stop" id="btnStop" style="display:none">Stop</button>
    </div>

    <!-- Right Sidebar: Context -->
    <div class="context-panel">
      <div class="ctx-section">
        <h3>Brand Status</h3>
        <div class="ctx-item">
          <span class="ctx-item-label">Onboarded</span>
          <span class="ctx-badge" id="ctxOnboarded">--</span>
        </div>
      </div>

      <div class="ctx-section">
        <h3>Intel Freshness</h3>
        <div id="ctxIntel"></div>
      </div>

      <div class="ctx-section">
        <h3>Context Files</h3>
        <div id="ctxFiles"></div>
      </div>

      <div class="ctx-section">
        <h3>Session Stats</h3>
        <div id="ctxStats">
          <div class="ctx-stat"><span>No active session</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toasts"></div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/markdown/markdown.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/yaml/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/shell/shell.min.js"></script>
  <script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // State
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const state = {
    agents: [],
    teams: [],
    sessions: new Map(),   // id -> SessionState
    activeSessionId: null,
    activePanel: 'chat',   // 'chat' | 'files'
    connected: false,
    ws: null,
    _pendingAgent: null,   // agent object when user picked an agent but hasn't typed yet
    // File browser state
    fileTreeState: {},      // path -> { expanded: bool, children: [] }
    openFilePath: null,
    openFileContent: null,
    fileDirty: false,
    cmEditor: null,
    // Tool progress tracking for live cards
    toolProgress: new Map(), // sessionId -> { toolName, elapsed }
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Markdown
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  marked.use({
    renderer: {
      code({ text, lang }) {
        let html;
        try {
          html = (lang && hljs.getLanguage(lang))
            ? hljs.highlight(text, { language: lang }).value
            : hljs.highlightAuto(text).value;
        } catch { html = esc(text); }
        return '<pre><code class="hljs">' + html + '</code></pre>';
      }
    },
    breaks: true,
    gfm: true,
  });

  function esc(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function md(text) {
    try { return marked.parse(text); }
    catch { return '<p>' + esc(text) + '</p>'; }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Helpers
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const COLORS = {
    purple:'#8b5cf6', cyan:'#06b6d4', blue:'#3b82f6', green:'#22c55e',
    amber:'#f59e0b', red:'#ef4444', pink:'#ec4899', indigo:'#6366f1',
    teal:'#14b8a6', orange:'#f97316', yellow:'#eab308', emerald:'#10b981',
    rose:'#f43f5e', lime:'#84cc16', sky:'#0ea5e9', violet:'#8b5cf6',
  };
  function ac(c) { return COLORS[c] || '#71717a'; }

  const TOOL_ICONS = {
    Read:'\u{1F4C4}', Write:'\u{270F}\u{FE0F}', Edit:'\u{270F}\u{FE0F}',
    Bash:'\u{1F4BB}', Glob:'\u{1F50D}', Grep:'\u{1F50E}',
    WebFetch:'\u{1F310}', WebSearch:'\u{1F310}', Task:'\u{1F680}',
    AskUserQuestion:'\u{2753}',
  };
  function tIcon(n) { return TOOL_ICONS[n] || '\u{2699}\u{FE0F}'; }

  function tSummary(name, inp) {
    const p = inp || {};
    if (name === 'Read' || name === 'Write' || name === 'Edit')
      return (p.file_path || '').split('/').pop();
    if (name === 'Bash') return (p.command || '').slice(0, 60);
    if (name === 'Glob') return p.pattern || '';
    if (name === 'Grep') return p.pattern || '';
    if (name === 'WebFetch') return p.url || '';
    if (name === 'WebSearch') return p.query || '';
    if (name === 'Task') return p.description || '';
    return '';
  }

  function fmtDuration(ms) {
    if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
    return Math.floor(ms / 60000) + 'm ' + Math.floor((ms % 60000) / 1000) + 's';
  }

  function fmtToolResult(content) {
    if (!content) return '';
    if (typeof content === 'string') return content.length > 500 ? content.slice(0, 500) + '...' : content;
    if (Array.isArray(content)) {
      const t = content.filter(b => b.type === 'text').map(b => b.text).join('\n');
      return t.length > 500 ? t.slice(0, 500) + '...' : t;
    }
    return JSON.stringify(content, null, 2).slice(0, 500);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // WebSocket
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let reconnTimer = null;

  function connectWS() {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(proto + '://' + location.host + '/ws');

    ws.onopen = () => {
      state.connected = true;
      state.ws = ws;
      updDot();
      ws.send(JSON.stringify({ type: 'sync' }));
      if (reconnTimer) { clearInterval(reconnTimer); reconnTimer = null; }
    };

    ws.onclose = () => {
      state.connected = false;
      state.ws = null;
      updDot();
      if (!reconnTimer) reconnTimer = setInterval(connectWS, 3000);
    };

    ws.onerror = () => ws.close();
    ws.onmessage = e => {
      try { onMsg(JSON.parse(e.data)); } catch {}
    };
  }

  function wsSend(msg) {
    if (state.ws?.readyState === WebSocket.OPEN) state.ws.send(JSON.stringify(msg));
  }

  function updDot() {
    document.getElementById('wsDot').className = 'ws-dot' + (state.connected ? ' connected' : '');
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Server Message Router
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function onMsg(msg) {
    switch (msg.type) {
      case 'sync_state':      return onSync(msg);
      case 'session_status':  return onStatus(msg);
      case 'text_delta':      return onDelta(msg);
      case 'assistant_message': return onAssistant(msg);
      case 'tool_result':     return onToolResult(msg);
      case 'permission_request': return onPermission(msg);
      case 'session_result':  return onResult(msg);
      case 'tool_progress':   return onToolProgress(msg);
      case 'error':           return toast(msg.message, 'error');
    }
  }

  function onToolProgress(msg) {
    state.toolProgress.set(msg.sessionId, { toolName: msg.toolName, elapsed: msg.elapsedSeconds });
    renderLiveCards();
  }

  // Map server session IDs to local sessions
  function migrate(msg) {
    if (state.sessions.has(msg.sessionId)) return;
    for (const [id, s] of state.sessions) {
      if (s.status === 'starting') {
        state.sessions.set(msg.sessionId, s);
        state.sessions.delete(id);
        if (state.activeSessionId === id) state.activeSessionId = msg.sessionId;
        return;
      }
    }
  }

  function onSync(msg) {
    state.agents = msg.agents || [];
    state.teams = msg.teams || [];
    renderAgentTeams();
    renderQuick();
    renderCtx(msg.intel);

    for (const s of (msg.sessions || [])) {
      if (!state.sessions.has(s.id)) {
        state.sessions.set(s.id, {
          agent: state.agents.find(a => a.name === s.agentName) || { name: s.agentName, displayName: s.agentDisplayName, color: s.agentColor },
          messages: [], status: s.status, cost: s.cost, turns: s.turns,
          startedAt: s.startedAt, streamBuf: '',
        });
      }
    }
    renderTabs(); renderLiveCards();
  }

  function onStatus(msg) {
    migrate(msg);
    const s = state.sessions.get(msg.sessionId);
    if (s) {
      s.status = msg.status;
      renderTabs(); renderLiveCards(); updInput();
      if (msg.sessionId === state.activeSessionId) updStats();
      // Update browser tab title
      if (msg.sessionId === state.activeSessionId && s.agent) {
        document.title = s.agent.displayName + ' â€” Command Center';
      }
    }
  }

  function onDelta(msg) {
    migrate(msg);
    const s = state.sessions.get(msg.sessionId);
    if (!s) return;
    s.streamBuf += msg.text;
    if (msg.sessionId === state.activeSessionId) renderStream(s);
  }

  function onAssistant(msg) {
    migrate(msg);
    const s = state.sessions.get(msg.sessionId);
    if (!s) return;
    s.streamBuf = '';
    s.messages.push({ role: 'assistant', content: msg.content });

    if (msg.sessionId === state.activeSessionId) {
      const area = $('chatArea');
      const el = area.querySelector('.streaming-msg');
      if (el) el.remove();
      renderChat();
    }
  }

  function onToolResult(msg) {
    migrate(msg);
    const s = state.sessions.get(msg.sessionId);
    if (!s) return;
    s.messages.push({ role: 'tool_result', toolId: msg.toolId, content: msg.content });

    if (msg.sessionId === state.activeSessionId) {
      const card = document.querySelector('[data-tool-id="' + msg.toolId + '"]');
      if (card) {
        const st = card.querySelector('.tool-status');
        if (st) { st.textContent = 'Done'; st.className = 'tool-status done'; }
        const body = card.querySelector('.tool-body');
        if (body) {
          const txt = fmtToolResult(msg.content);
          if (txt) {
            const lbl = document.createElement('div');
            lbl.className = 'tool-result-label'; lbl.textContent = 'Result';
            body.appendChild(lbl);
            const pre = document.createElement('pre');
            pre.textContent = txt;
            body.appendChild(pre);
          }
        }
      }
    }
  }

  function onPermission(msg) {
    migrate(msg);
    const s = state.sessions.get(msg.sessionId);
    if (!s) return;
    s.messages.push({
      role: 'permission_request', requestId: msg.requestId,
      toolName: msg.toolName, input: msg.input, resolved: false,
    });
    if (state.activeSessionId !== msg.sessionId) {
      state.activeSessionId = msg.sessionId;
      renderTabs();
    }
    renderChat();
    toast('Permission needed: ' + msg.toolName, 'info');
  }

  function onResult(msg) {
    migrate(msg);
    const s = state.sessions.get(msg.sessionId);
    if (!s) return;
    s.cost = msg.cost; s.turns = msg.turns;
    s.messages.push({
      role: 'result', cost: msg.cost, turns: msg.turns,
      durationMs: msg.durationMs, result: msg.result, isError: msg.isError,
    });
    if (msg.sessionId === state.activeSessionId) { renderChat(); updStats(); }
    renderTabs(); renderLiveCards();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Rendering
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function $(id) { return document.getElementById(id); }

  function renderAgentTeams() {
    const teams = state.teams;
    if (!teams.length) {
      // Fallback: render flat list if teams not available
      const el = $('teamList');
      el.innerHTML = state.agents.map(a =>
        '<div class="agent-card" onclick="pickAgent(\'' + a.name + '\')">' +
          '<div class="agent-dot" style="background:' + ac(a.color) + '"></div>' +
          '<div class="agent-info"><div class="agent-name">' + a.displayName + '</div>' +
          '<div class="agent-desc">' + a.description + '</div></div>' +
          '<span class="agent-hotkey">' + a.hotkey + '</span></div>'
      ).join('');
      return;
    }

    let h = '';
    for (let ti = 0; ti < teams.length; ti++) {
      const t = teams[ti];
      const isOrch = t.name === 'orchestrators';
      h += '<details class="team-group"' + (isOrch ? ' open' : '') + ' style="--team-color:' + t.color + '">' +
        '<summary><span class="team-icon">' + t.icon + '</span> ' + t.label +
        '<span class="team-count">' + t.agents.length + '</span></summary>';
      for (let ai = 0; ai < t.agents.length; ai++) {
        const a = t.agents[ai];
        h += '<div class="agent-card" onclick="pickAgent(\'' + a.name + '\')" style="animation-delay:' + (ai * 0.04) + 's">' +
          '<div class="agent-dot" style="background:' + ac(a.color) + '"></div>' +
          '<div class="agent-info"><div class="agent-name">' + a.displayName + '</div>' +
          '<div class="agent-desc">' + (a.description || '') + '</div></div>' +
          '<span class="agent-hotkey">' + (a.hotkey || '') + '</span></div>';
      }
      h += '</details>';
    }
    $('teamList').innerHTML = h;
  }

  function renderQuick() {
    const q = state.agents.filter(a => a.isOrchestrator);
    $('quickAgents').innerHTML = q.map(a =>
      '<button class="quick-agent-btn" onclick="pickAgent(\'' + a.name + '\')" style="border-color:' +
      ac(a.color) + '">' + a.displayName + '</button>'
    ).join('');
  }

  function renderTabs() {
    const el = $('sessionTabs');
    if (state.sessions.size === 0) {
      el.innerHTML = '<span class="no-tabs-hint">No active sessions</span>';
      return;
    }
    let h = '';
    for (const [id, s] of state.sessions) {
      const cls = id === state.activeSessionId ? ' active' : '';
      h += '<div class="session-tab' + cls + '" onclick="switchTo(\'' + id + '\')">' +
        '<span class="session-dot ' + s.status + '"></span>' +
        '<span>' + (s.agent.displayName || s.agent.name) + '</span>' +
        '<span class="close-btn" onclick="event.stopPropagation();closeSess(\'' + id + '\')">&times;</span></div>';
    }
    el.innerHTML = h;
  }

  function renderLiveCards() {
    const el = $('liveCards');
    if (state.sessions.size === 0) {
      el.innerHTML = '<div style="padding:4px 8px;font-size:10px;color:var(--text-dim)">No active sessions</div>';
      return;
    }
    let h = '';
    for (const [id, s] of state.sessions) {
      const prog = state.toolProgress.get(id);
      const detail = prog ? prog.toolName + ' (' + prog.elapsed.toFixed(0) + 's)' :
        '$' + s.cost.toFixed(4) + ' \u00B7 ' + s.turns + ' turns';
      h += '<div class="live-card" onclick="switchTo(\'' + id + '\')">' +
        '<div class="live-dot ' + s.status + '"></div>' +
        '<div class="live-card-info"><div class="live-card-name">' + (s.agent.displayName || s.agent.name) + '</div>' +
        '<div class="live-card-detail">' + detail + '</div></div>' +
        '<span class="live-dismiss" onclick="event.stopPropagation();closeSess(\'' + id + '\')">&times;</span></div>';
    }
    el.innerHTML = h;
  }

  function emptyStateHtml() {
    const qbtns = state.agents.filter(a => a.isOrchestrator).map(a =>
      '<button class="quick-agent-btn" onclick="pickAgent(\'' + a.name + '\')" style="border-color:' +
      ac(a.color) + '">' + a.displayName + '</button>'
    ).join('');
    return '<div class="empty-state">' +
      '<h2>Command Center</h2>' +
      '<div class="brand-dots"><span style="background:#f97316"></span><span style="background:#8b5cf6"></span><span style="background:#3b82f6"></span><span style="background:#10b981"></span></div>' +
      '<p>Select an agent from the sidebar or use a quick launch below to start an interactive session. Your agents can plan campaigns, analyze performance, create content, and more.</p>' +
      '<div class="quick-agents">' + qbtns + '</div></div>';
  }

  function renderChat() {
    const area = $('chatArea');

    if (!state.activeSessionId || !state.sessions.has(state.activeSessionId)) {
      area.innerHTML = emptyStateHtml();
      updInput();
      return;
    }

    const s = state.sessions.get(state.activeSessionId);
    let h = '';

    for (const m of s.messages) {
      if (m.role === 'user') {
        h += '<div class="message user">' + esc(m.content) + '</div>';
      } else if (m.role === 'assistant') {
        h += renderAssistant(m.content, s.agent);
      } else if (m.role === 'permission_request') {
        h += (m.toolName === 'AskUserQuestion') ? renderAsk(m) : renderPerm(m);
      } else if (m.role === 'result') {
        h += renderResultCard(m);
      }
      // tool_result handled via DOM updates on existing cards
    }

    // Streaming buffer
    if (s.streamBuf) {
      h += '<div class="message assistant streaming-msg">' +
        '<div class="msg-agent-label" style="color:' + ac(s.agent.color) + '">' + (s.agent.displayName || s.agent.name) + '</div>' +
        '<div class="msg-content streaming-cursor">' + md(s.streamBuf) + '</div></div>';
    }

    area.innerHTML = h;
    attachPermHandlers();
    // Detect numbered options in assistant messages and render as clickable buttons
    area.querySelectorAll('.message.assistant').forEach(msg => injectQuickReplies(msg));
    area.scrollTop = area.scrollHeight;
    updInput();
  }

  function renderStream(s) {
    const area = $('chatArea');
    let el = area.querySelector('.streaming-msg');
    if (!el) {
      const empty = area.querySelector('.empty-state');
      if (empty) empty.remove();
      el = document.createElement('div');
      el.className = 'message assistant streaming-msg';
      el.innerHTML = '<div class="msg-agent-label" style="color:' + ac(s.agent.color) + '">' +
        (s.agent.displayName || s.agent.name) + '</div><div class="msg-content streaming-cursor"></div>';
      area.appendChild(el);
    }
    el.querySelector('.msg-content').innerHTML = md(s.streamBuf);
    area.scrollTop = area.scrollHeight;
  }

  function renderAssistant(content, agent) {
    let h = '<div class="message assistant"><div class="msg-agent-label" style="color:' +
      ac(agent.color) + '">' + (agent.displayName || agent.name) + '</div><div class="msg-content">';
    for (const b of content) {
      if (b.type === 'text') h += md(b.text);
      else if (b.type === 'tool_use') h += renderTool(b);
    }
    return h + '</div></div>';
  }

  function renderTool(b) {
    const sum = tSummary(b.name, b.input);
    const inp = JSON.stringify(b.input, null, 2);
    return '<div class="tool-card" data-tool-id="' + b.id + '">' +
      '<div class="tool-header" onclick="toggleTool(this)">' +
        '<span class="tool-icon">' + tIcon(b.name) + '</span>' +
        '<span class="tool-name">' + b.name + '</span>' +
        '<span class="tool-summary">' + esc(sum) + '</span>' +
        '<span class="tool-status running">Running</span></div>' +
      '<div class="tool-body"><pre>' + esc(inp) + '</pre></div></div>';
  }

  function renderPerm(m) {
    const inp = JSON.stringify(m.input, null, 2);
    const dis = m.resolved ? ' disabled' : '';
    return '<div class="permission-card" data-request-id="' + m.requestId + '">' +
      '<div class="permission-header">Permission Required: ' + m.toolName + '</div>' +
      '<div class="permission-body"><pre>' + esc(inp) + '</pre>' +
      '<div class="permission-actions">' +
        '<button class="btn-allow"' + dis + ' data-action="allow" data-rid="' + m.requestId + '">Allow</button>' +
        '<button class="btn-deny"' + dis + ' data-action="deny" data-rid="' + m.requestId + '">Deny</button>' +
      '</div></div></div>';
  }

  function renderAsk(m) {
    const qs = m.input.questions || [];
    const dis = m.resolved ? ' disabled' : '';
    let h = '<div class="ask-card" data-request-id="' + m.requestId + '">' +
      '<div class="ask-header">Choose Your Path</div><div class="ask-body">';

    for (const q of qs) {
      h += '<div class="ask-question">' + esc(q.question) + '</div>' +
        '<div class="ask-options" data-question="' + esc(q.question) + '">';
      for (const o of (q.options || [])) {
        h += '<div class="ask-option" data-label="' + esc(o.label) + '" onclick="selOpt(this)">' +
          '<div class="ask-option-label">' + esc(o.label) + '</div>' +
          (o.description ? '<div class="ask-option-desc">' + esc(o.description) + '</div>' : '') + '</div>';
      }
      h += '</div>';
    }

    h += '<button class="ask-submit"' + dis + ' data-rid="' + m.requestId + '" onclick="submitAsk(this)">Submit</button>';
    return h + '</div></div>';
  }

  function renderResultCard(m) {
    const cls = m.isError ? ' error' : '';
    return '<div class="result-card' + cls + '">' +
      '<div class="result-header">' + (m.isError ? 'Session Error' : 'Session Complete') + '</div>' +
      '<div class="result-stats">' +
        '<div class="result-stat">Cost: <span>$' + m.cost.toFixed(4) + '</span></div>' +
        '<div class="result-stat">Turns: <span>' + m.turns + '</span></div>' +
        '<div class="result-stat">Duration: <span>' + fmtDuration(m.durationMs) + '</span></div>' +
      '</div></div>';
  }

  function renderCtx(intel) {
    if (!intel) return;
    const ob = $('ctxOnboarded');
    ob.textContent = intel.isOnboarded ? 'Yes' : 'No';
    ob.className = 'ctx-badge ' + (intel.isOnboarded ? 'yes' : 'no');

    const ie = $('ctxIntel');
    ie.innerHTML = (intel.intel?.items || []).map(i =>
      '<div class="ctx-item"><span class="ctx-item-label">' + i.label +
      '</span><span class="ctx-badge ' + i.status + '">' + i.displayLabel + '</span></div>'
    ).join('') +
      (intel.intel?.ledgerCount !== undefined
        ? '<div class="ctx-item"><span class="ctx-item-label">Ledger Entries</span><span class="ctx-badge fresh">' + intel.intel.ledgerCount + '</span></div>'
        : '');

    $('ctxFiles').innerHTML = (intel.contextFiles || []).map(f =>
      '<div class="ctx-item"><span class="ctx-item-label">' + f.label +
      '</span><span class="ctx-badge ' + (f.exists ? 'yes' : 'no') + '">' + (f.exists ? 'OK' : 'Missing') + '</span></div>'
    ).join('');
  }

  function updStats() {
    const el = $('ctxStats');
    if (!state.activeSessionId) {
      el.innerHTML = '<div class="ctx-stat"><span>No active session</span></div>';
      return;
    }
    const s = state.sessions.get(state.activeSessionId);
    if (!s) return;
    const dur = fmtDuration(Date.now() - s.startedAt);
    el.innerHTML =
      '<div class="ctx-stat"><span>Status</span><span class="ctx-stat-value">' + s.status + '</span></div>' +
      '<div class="ctx-stat"><span>Cost</span><span class="ctx-stat-value">$' + s.cost.toFixed(4) + '</span></div>' +
      '<div class="ctx-stat"><span>Turns</span><span class="ctx-stat-value">' + s.turns + '</span></div>' +
      '<div class="ctx-stat"><span>Duration</span><span class="ctx-stat-value">' + dur + '</span></div>' +
      '<div class="ctx-stat"><span>Messages</span><span class="ctx-stat-value">' + s.messages.length + '</span></div>';
  }

  function updInput() {
    const inp = $('inputText');
    const send = $('btnSend');
    const stop = $('btnStop');

    if (state._pendingAgent) {
      send.disabled = !inp.value.trim();
      stop.style.display = 'none';
      return;
    }

    if (!state.activeSessionId) {
      send.disabled = true;
      stop.style.display = 'none';
      inp.placeholder = 'Select an agent to start...';
      return;
    }

    const s = state.sessions.get(state.activeSessionId);
    if (!s) return;

    const running = s.status === 'running' || s.status === 'starting';
    const waiting = s.status === 'waiting_permission';
    const idle = s.status === 'idle';
    const done = s.status === 'completed';

    send.disabled = !inp.value.trim() || waiting;
    stop.style.display = running ? '' : 'none';

    if (done) inp.placeholder = 'Session ended. Start a new session...';
    else if (idle) inp.placeholder = 'Send a follow-up message...';
    else if (waiting) inp.placeholder = 'Respond to the permission request above...';
    else inp.placeholder = 'Type a message... (Cmd+Enter to send)';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Actions
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function pickAgent(name) {
    const agent = state.agents.find(a => a.name === name);
    if (!agent) return;
    state._pendingAgent = agent;
    const inp = $('inputText');
    inp.focus();
    inp.placeholder = agent.isOrchestrator
      ? 'Message ' + agent.displayName + '... (e.g. "Plan February content calendar")'
      : 'Task for ' + agent.displayName + '...';
    $('btnSend').disabled = !inp.value.trim();
  }

  function startSess(agentName, prompt) {
    wsSend({ type: 'start_session', agentName, prompt });
    const agent = state.agents.find(a => a.name === agentName) || { name: agentName, displayName: agentName, color: 'purple' };
    const id = agentName + '-' + Date.now().toString(36);
    state.sessions.set(id, {
      agent, messages: [{ role: 'user', content: prompt }],
      status: 'starting', cost: 0, turns: 0, startedAt: Date.now(), streamBuf: '',
    });
    state.activeSessionId = id;
    state._pendingAgent = null;
    renderTabs(); renderLiveCards(); renderChat(); updInput();
  }

  function switchTo(id) {
    state.activeSessionId = id;
    renderTabs(); renderLiveCards(); renderChat(); updStats(); updInput();
  }

  function closeSess(id) {
    const s = state.sessions.get(id);
    if (s && (s.status === 'running' || s.status === 'starting')) {
      wsSend({ type: 'interrupt_session', sessionId: id });
    }
    state.sessions.delete(id);
    if (state.activeSessionId === id) {
      const keys = [...state.sessions.keys()];
      state.activeSessionId = keys.length > 0 ? keys[keys.length - 1] : null;
    }
    renderTabs(); renderLiveCards(); renderChat(); updStats(); updInput();
  }

  function doSend() {
    const inp = $('inputText');
    const text = inp.value.trim();
    if (!text) return;

    if (state._pendingAgent) {
      startSess(state._pendingAgent.name, text);
      inp.value = ''; autoSize(inp);
      return;
    }

    if (!state.activeSessionId) return;
    const s = state.sessions.get(state.activeSessionId);
    if (!s) return;

    if (s.status === 'completed') {
      startSess(s.agent.name, text);
      inp.value = ''; autoSize(inp);
      return;
    }

    wsSend({ type: 'user_message', sessionId: state.activeSessionId, message: text });
    s.messages.push({ role: 'user', content: text });
    renderChat();
    inp.value = ''; autoSize(inp);
  }

  function doStop() {
    if (!state.activeSessionId) return;
    wsSend({ type: 'interrupt_session', sessionId: state.activeSessionId });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Permission / Ask handlers
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function attachPermHandlers() {
    document.querySelectorAll('.permission-actions button').forEach(btn => {
      btn.onclick = function() {
        const rid = this.dataset.rid;
        const allow = this.dataset.action === 'allow';
        wsSend({ type: 'permission_response', sessionId: state.activeSessionId, requestId: rid, allow });
        this.closest('.permission-card').querySelectorAll('button').forEach(b => b.disabled = true);
        const s = state.sessions.get(state.activeSessionId);
        if (s) { const m = s.messages.find(x => x.requestId === rid); if (m) m.resolved = true; }
      };
    });
  }

  function selOpt(el) {
    el.parentElement.querySelectorAll('.ask-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
  }

  function submitAsk(btn) {
    const card = btn.closest('.ask-card');
    const rid = btn.dataset.rid;
    const answers = {};
    card.querySelectorAll('.ask-options').forEach(g => {
      const q = g.dataset.question;
      const sel = g.querySelector('.ask-option.selected');
      if (sel) answers[q] = sel.dataset.label;
    });

    const s = state.sessions.get(state.activeSessionId);
    const m = s?.messages.find(x => x.requestId === rid);
    const updatedInput = m ? { ...m.input, answers } : { answers };

    wsSend({ type: 'permission_response', sessionId: state.activeSessionId, requestId: rid, allow: true, updatedInput });
    btn.disabled = true;
    card.querySelectorAll('.ask-option').forEach(o => o.style.pointerEvents = 'none');
    if (m) m.resolved = true;
  }

  function toggleTool(hdr) { hdr.nextElementSibling.classList.toggle('expanded'); }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Quick-reply detection for numbered agent options
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function injectQuickReplies(container) {
    if (!container) return;
    // Skip if this message already contains an AskUserQuestion card
    if (container.querySelector('.ask-card')) return;

    container.querySelectorAll('.msg-content > ol, .msg-content ol').forEach(ol => {
      // Only process top-level <ol> (skip nested)
      if (ol.parentElement.tagName === 'LI') return;

      const items = Array.from(ol.children).filter(c => c.tagName === 'LI');
      if (items.length < 2) return;

      // Check if 60%+ of items have a <strong> or <b> as leading element
      let boldCount = 0;
      for (const li of items) {
        const first = li.querySelector('strong, b');
        if (first) boldCount++;
      }
      if (boldCount / items.length < 0.6) return;

      // Build quick-reply buttons
      const wrap = document.createElement('div');
      wrap.className = 'quick-replies' + (items.length > 8 ? ' qr-scrollable' : '');

      for (const li of items) {
        const strong = li.querySelector('strong, b');
        if (!strong) continue;

        const label = strong.textContent.trim();
        // Get description: remaining text after the bold element
        const clone = li.cloneNode(true);
        const boldEl = clone.querySelector('strong, b');
        if (boldEl) boldEl.remove();
        let desc = clone.textContent.trim().replace(/^[\s\-â€”:]+/, '').trim();

        const btn = document.createElement('button');
        btn.className = 'qr-btn';
        btn.innerHTML = '<div class="qr-label">' + esc(label) + '</div>' +
          (desc ? '<div class="qr-desc">' + esc(desc) + '</div>' : '');
        btn.onclick = function() { quickReply(label, this); };
        wrap.appendChild(btn);
      }

      // Hide original list, insert buttons after it
      ol.style.display = 'none';
      ol.insertAdjacentElement('afterend', wrap);
    });
  }

  function quickReply(text, clickedBtn) {
    // Send the option text as a user message
    const inp = $('inputText');
    inp.value = text;
    doSend();

    // Mark all buttons in this container
    const container = clickedBtn.closest('.quick-replies');
    if (container) {
      container.querySelectorAll('.qr-btn').forEach(b => b.classList.add('sent'));
      clickedBtn.classList.remove('sent');
      clickedBtn.classList.add('sent-active');
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Toast
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toast(msg, type) {
    const t = document.createElement('div');
    t.className = 'toast ' + (type || 'info');
    t.textContent = msg;
    $('toasts').appendChild(t);
    setTimeout(() => t.remove(), 3500);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Input
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function autoSize(ta) {
    ta.style.height = 'auto';
    ta.style.height = Math.min(ta.scrollHeight, 120) + 'px';
  }

  const inputEl = $('inputText');

  inputEl.addEventListener('input', () => {
    autoSize(inputEl);
    $('btnSend').disabled = !inputEl.value.trim();
  });

  inputEl.addEventListener('keydown', e => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); doSend(); }
  });

  $('btnSend').addEventListener('click', doSend);
  $('btnStop').addEventListener('click', doStop);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Keyboard shortcuts
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      if (state._pendingAgent) {
        state._pendingAgent = null;
        inputEl.value = '';
        updInput();
      }
      return;
    }
    if (document.activeElement === inputEl) return;

    // Agent hotkeys
    const a = state.agents.find(x => x.hotkey.toLowerCase() === e.key.toLowerCase());
    if (a && !e.metaKey && !e.ctrlKey && !e.altKey) { pickAgent(a.name); return; }

    // / to focus input
    if (e.key === '/' && !e.metaKey && !e.ctrlKey) { e.preventDefault(); inputEl.focus(); }

    // Cmd+1/Cmd+2 to switch panels
    if ((e.metaKey || e.ctrlKey) && e.key === '1') { e.preventDefault(); switchPanel('chat'); }
    if ((e.metaKey || e.ctrlKey) && e.key === '2') { e.preventDefault(); switchPanel('files'); }
  });

  // Cmd+S to save file
  document.addEventListener('keydown', e => {
    if ((e.metaKey || e.ctrlKey) && e.key === 's' && state.activePanel === 'files' && state.fileDirty) {
      e.preventDefault();
      saveFile();
    }
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Panel Switching
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchPanel(panel) {
    state.activePanel = panel;
    document.querySelectorAll('.panel-tab').forEach(t => t.classList.toggle('active', t.dataset.panel === panel));

    const chatArea = $('chatArea');
    const sessionTabs = $('sessionTabs');
    const fileBrowser = $('fileBrowser');
    const inputBar = document.querySelector('.input-bar');

    if (panel === 'chat') {
      chatArea.style.display = '';
      sessionTabs.style.display = '';
      fileBrowser.classList.remove('active');
      if (inputBar) inputBar.style.display = '';
    } else {
      chatArea.style.display = 'none';
      sessionTabs.style.display = 'none';
      fileBrowser.classList.add('active');
      if (inputBar) inputBar.style.display = 'none';
      if (!state.fileTreeState._loaded) loadFileRoots();
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // File Browser
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const FILE_ICONS = {
    md: '\u{1F4DD}', json: '\u{1F4CB}', ts: '\u{1F4DC}', js: '\u{1F4DC}',
    html: '\u{1F310}', css: '\u{1F3A8}', sh: '\u{1F4BB}', yaml: '\u{2699}\u{FE0F}', yml: '\u{2699}\u{FE0F}',
  };

  function fileIcon(name) {
    const ext = name.split('.').pop().toLowerCase();
    return FILE_ICONS[ext] || '\u{1F4C4}';
  }

  async function loadFileRoots() {
    state.fileTreeState._loaded = true;
    const tree = $('fileTree');
    tree.innerHTML = '<div class="skeleton"></div><div class="skeleton" style="width:70%"></div><div class="skeleton" style="width:85%"></div>';
    try {
      const res = await fetch('/api/files/list');
      const roots = await res.json();
      state.fileTreeState._roots = roots;
      renderFileTree();
    } catch (err) {
      tree.innerHTML = '<div style="padding:12px;color:var(--red);font-size:11px">Failed to load files</div>';
    }
  }

  async function toggleDir(path) {
    const s = state.fileTreeState[path];
    if (s && s.expanded) {
      state.fileTreeState[path].expanded = false;
      renderFileTree();
      return;
    }
    // Load children
    state.fileTreeState[path] = { expanded: true, children: null };
    renderFileTree();
    try {
      const res = await fetch('/api/files/list?path=' + encodeURIComponent(path));
      const children = await res.json();
      state.fileTreeState[path].children = children;
      renderFileTree();
    } catch {
      state.fileTreeState[path].children = [];
      renderFileTree();
    }
  }

  function renderFileTree() {
    const tree = $('fileTree');
    const roots = state.fileTreeState._roots || [];
    let h = '';

    function renderEntry(entry, depth) {
      const indent = depth;
      if (entry.type === 'directory') {
        const s = state.fileTreeState[entry.path];
        const expanded = s && s.expanded;
        const arrowCls = expanded ? 'tree-arrow open' : 'tree-arrow';
        h += '<div class="file-tree-item" style="--depth:' + indent + '" onclick="toggleDir(\'' + esc(entry.path) + '\')">' +
          '<span class="' + arrowCls + '">\u25B6</span>' +
          '<span class="tree-icon">\u{1F4C1}</span>' +
          '<span>' + esc(entry.name) + '</span></div>';
        if (expanded && s.children) {
          for (const child of s.children) renderEntry(child, depth + 1);
        } else if (expanded && !s.children) {
          h += '<div class="skeleton" style="margin-left:' + ((indent + 1) * 16 + 8) + 'px"></div>';
        }
      } else {
        const active = state.openFilePath === entry.path ? ' active' : '';
        h += '<div class="file-tree-item' + active + '" style="--depth:' + indent + '" onclick="openFile(\'' + esc(entry.path) + '\')">' +
          '<span class="tree-arrow" style="visibility:hidden">\u25B6</span>' +
          '<span class="tree-icon">' + fileIcon(entry.name) + '</span>' +
          '<span>' + esc(entry.name) + '</span></div>';
      }
    }

    for (const root of roots) renderEntry(root, 0);
    tree.innerHTML = h || '<div style="padding:12px;color:var(--text-dim);font-size:11px">No files found</div>';
  }

  async function openFile(path) {
    if (state.fileDirty && state.openFilePath && state.openFilePath !== path) {
      if (!confirm('You have unsaved changes. Discard them?')) return;
    }
    state.openFilePath = path;
    state.fileDirty = false;
    renderFileTree();

    const editor = $('fileEditor');
    editor.innerHTML = '<div class="file-editor-toolbar">' +
      '<span class="file-editor-path">' + esc(path) + '</span>' +
      '<span class="file-editor-size" id="fileSize">Loading...</span>' +
      '<span class="file-editor-dirty" id="fileDirtyBadge" style="display:none">\u2022 Modified</span>' +
      '<button class="btn-save" id="btnSave" disabled onclick="saveFile()">Save</button>' +
      '</div><div class="file-editor-content" id="editorContent"></div>';

    try {
      const res = await fetch('/api/files/read?path=' + encodeURIComponent(path));
      if (!res.ok) throw new Error('Failed to load');
      const data = await res.json();
      state.openFileContent = data.content;
      $('fileSize').textContent = formatBytes(data.size);
      initEditor(data.content, path);
    } catch (err) {
      $('editorContent').innerHTML = '<div class="file-editor-empty" style="color:var(--red)">Failed to load file</div>';
    }
  }

  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  function getCmMode(path) {
    const ext = path.split('.').pop().toLowerCase();
    const map = { md: 'markdown', json: 'javascript', js: 'javascript', ts: 'javascript', html: 'htmlmixed', css: 'css', yaml: 'yaml', yml: 'yaml', sh: 'shell' };
    return map[ext] || null;
  }

  function initEditor(content, path) {
    const container = $('editorContent');

    // Try CodeMirror
    if (typeof CodeMirror !== 'undefined') {
      try {
        state.cmEditor = CodeMirror(container, {
          value: content,
          mode: getCmMode(path),
          theme: 'material-darker',
          lineNumbers: true,
          lineWrapping: true,
          tabSize: 2,
          indentWithTabs: false,
        });
        state.cmEditor.on('change', () => {
          const dirty = state.cmEditor.getValue() !== state.openFileContent;
          state.fileDirty = dirty;
          const badge = $('fileDirtyBadge');
          const btn = $('btnSave');
          if (badge) badge.style.display = dirty ? '' : 'none';
          if (btn) btn.disabled = !dirty;
        });
        return;
      } catch {}
    }

    // Fallback: plain textarea
    const ta = document.createElement('textarea');
    ta.className = 'fallback-editor';
    ta.value = content;
    ta.addEventListener('input', () => {
      const dirty = ta.value !== state.openFileContent;
      state.fileDirty = dirty;
      const badge = $('fileDirtyBadge');
      const btn = $('btnSave');
      if (badge) badge.style.display = dirty ? '' : 'none';
      if (btn) btn.disabled = !dirty;
    });
    container.appendChild(ta);
  }

  async function saveFile() {
    if (!state.openFilePath || !state.fileDirty) return;

    const content = state.cmEditor ? state.cmEditor.getValue() :
      $('editorContent').querySelector('.fallback-editor')?.value;
    if (content === undefined) return;

    const btn = $('btnSave');
    if (btn) { btn.disabled = true; btn.textContent = 'Saving...'; }

    try {
      const res = await fetch('/api/files/write', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: state.openFilePath, content }),
      });
      if (!res.ok) throw new Error('Save failed');
      const data = await res.json();
      state.openFileContent = content;
      state.fileDirty = false;
      const badge = $('fileDirtyBadge');
      if (badge) badge.style.display = 'none';
      if (btn) btn.textContent = 'Save';
      $('fileSize').textContent = formatBytes(data.size);
      toast('Saved ' + state.openFilePath.split('/').pop(), 'success');
    } catch (err) {
      toast('Failed to save file', 'error');
      if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Session stats live update + live card refresh
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setInterval(() => {
    if (state.activeSessionId) {
      const s = state.sessions.get(state.activeSessionId);
      if (s && (s.status === 'running' || s.status === 'starting')) updStats();
    }
    // Refresh live cards periodically for elapsed time
    if (state.sessions.size > 0) renderLiveCards();
  }, 1000);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Init
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  connectWS();

  fetch('/api/agents').then(r => r.json()).then(agents => {
    if (state.agents.length === 0) {
      state.agents = agents.map(a => ({
        name: a.name, displayName: a.displayName, shortTag: a.shortTag,
        color: a.color, description: a.description, hotkey: a.hotkey,
        isOrchestrator: a.isOrchestrator,
      }));
      renderAgentTeams(); renderQuick();
    }
  }).catch(() => {});

  fetch('/api/intel').then(r => r.json()).then(renderCtx).catch(() => {});
  </script>
</body>
</html>
