<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marketing Command Center</title>
<style>
  :root {
    --bg: #0a0a0f;
    --bg-panel: #111118;
    --bg-card: #1a1a24;
    --bg-hover: #22222e;
    --border: #2a2a3a;
    --border-active: #7c6bff;
    --fg: #e0e0e8;
    --fg-dim: #6b6b80;
    --accent: #7c6bff;
    --accent-glow: rgba(124, 107, 255, 0.15);
    --success: #4ade80;
    --warning: #fbbf24;
    --error: #ef4444;
    --info: #22d3ee;
    --blue: #3b82f6;
    --green: #22c55e;
    --purple: #a855f7;
    --pink: #ec4899;
    --red: #ef4444;
    --cyan: #06b6d4;
    --orange: #f97316;
    --amber: #f59e0b;
    --radius: 10px;
    --radius-sm: 6px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--fg);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ── Status Bar ── */
  .status-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-panel);
    flex-shrink: 0;
  }
  .status-bar .title {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 0.5px;
    color: var(--accent);
  }
  .status-indicators {
    display: flex;
    gap: 20px;
    align-items: center;
  }
  .indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: var(--fg-dim);
  }
  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .dot.on { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .dot.warn { background: var(--warning); }
  .dot.off { background: var(--fg-dim); opacity: 0.4; }
  .dot.pulse { animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  .status-right {
    display: flex;
    gap: 16px;
    align-items: center;
    font-size: 12px;
    color: var(--fg-dim);
  }

  /* ── Main Layout ── */
  .main {
    display: grid;
    grid-template-columns: 260px 1fr 280px;
    flex: 1;
    overflow: hidden;
  }

  .panel {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    overflow: hidden;
  }
  .panel:last-child { border-right: none; }

  .panel-header {
    padding: 14px 16px 10px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--fg-dim);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }
  .panel-header .badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--bg-card);
    color: var(--fg-dim);
    font-weight: 500;
    letter-spacing: 0;
    text-transform: none;
  }

  .panel-body {
    flex: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .panel-body::-webkit-scrollbar { width: 5px; }
  .panel-body::-webkit-scrollbar-track { background: transparent; }
  .panel-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ── Agent Panel ── */
  .agent-section-label {
    padding: 10px 16px 4px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--fg-dim);
    opacity: 0.6;
  }

  .agent-row {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    gap: 10px;
    cursor: pointer;
    transition: background 0.15s;
    border-left: 3px solid transparent;
    user-select: none;
  }
  .agent-row:hover { background: var(--bg-hover); }
  .agent-row.selected {
    background: var(--accent-glow);
    border-left-color: var(--accent);
  }
  .agent-row.spawned { padding-left: 32px; }
  .agent-row .tree-connector {
    color: var(--fg-dim);
    font-size: 12px;
    opacity: 0.5;
    width: 16px;
    flex-shrink: 0;
  }

  .agent-color-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .agent-name {
    flex: 1;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .agent-hotkey {
    font-size: 11px;
    color: var(--fg-dim);
    background: var(--bg-card);
    padding: 1px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', Menlo, monospace;
    flex-shrink: 0;
  }
  .agent-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .agent-status.active { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .agent-status.idle { background: var(--fg-dim); opacity: 0.3; }

  .agent-detail {
    margin: 2px 12px 6px;
    padding: 10px 12px;
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    font-size: 12px;
    color: var(--fg-dim);
    line-height: 1.6;
  }
  .agent-detail .detail-desc {
    margin-bottom: 8px;
  }
  .agent-detail .copy-cmd {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 6px;
  }
  .agent-detail code {
    flex: 1;
    font-family: 'SF Mono', Menlo, monospace;
    font-size: 11px;
    background: var(--bg);
    padding: 5px 10px;
    border-radius: 4px;
    color: var(--fg);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .copy-btn {
    padding: 4px 10px;
    font-size: 11px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
    transition: opacity 0.15s;
  }
  .copy-btn:hover { opacity: 0.85; }
  .copy-btn:active { transform: scale(0.97); }

  /* ── Activity Stream ── */
  .stream-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 16px;
    flex-shrink: 0;
  }
  .stream-filter {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: rgba(251, 191, 36, 0.08);
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    flex-shrink: 0;
  }
  .stream-filter .filter-label { color: var(--warning); font-weight: 600; }
  .stream-filter .clear-btn {
    margin-left: auto;
    background: none;
    border: 1px solid var(--border);
    color: var(--fg-dim);
    padding: 2px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
  }
  .stream-filter .clear-btn:hover { border-color: var(--fg-dim); color: var(--fg); }

  .clear-events-btn {
    margin-left: auto;
    background: none;
    border: 1px solid var(--border);
    color: var(--fg-dim);
    padding: 3px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.15s;
  }
  .clear-events-btn:hover { border-color: var(--fg-dim); color: var(--fg); }

  .event-card {
    display: flex;
    padding: 6px 16px;
    gap: 8px;
    border-bottom: 1px solid rgba(42, 42, 58, 0.4);
    align-items: flex-start;
    transition: background 0.1s;
  }
  .event-card:hover { background: var(--bg-hover); }

  .event-stripe {
    width: 3px;
    min-height: 28px;
    border-radius: 2px;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .event-body { flex: 1; min-width: 0; }
  .event-top {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .event-agent-tag {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
    padding: 1px 6px;
    border-radius: 4px;
    white-space: nowrap;
  }
  .event-time {
    font-size: 11px;
    color: var(--fg-dim);
    font-family: 'SF Mono', Menlo, monospace;
    flex-shrink: 0;
  }
  .event-badge {
    font-size: 11px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .event-context {
    font-size: 12px;
    color: var(--fg-dim);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .event-indent-1 { padding-left: 32px; }

  /* ── Empty / Getting Started ── */
  .empty-stream {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 16px;
    color: var(--fg-dim);
    text-align: center;
    padding: 40px;
  }
  .empty-stream .icon { font-size: 32px; opacity: 0.3; }
  .empty-stream .msg { font-size: 16px; color: var(--fg); font-weight: 500; }
  .empty-stream .hint { font-size: 13px; opacity: 0.7; max-width: 400px; line-height: 1.5; }

  .getting-started {
    padding: 24px 32px;
    max-width: 560px;
    margin: 0 auto;
  }
  .getting-started h2 {
    font-size: 18px;
    font-weight: 600;
    color: var(--fg);
    margin-bottom: 20px;
    text-align: center;
  }
  .step {
    display: flex;
    gap: 14px;
    margin-bottom: 20px;
    align-items: flex-start;
  }
  .step-num {
    width: 28px;
    height: 28px;
    background: var(--accent);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 700;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .step-content { flex: 1; }
  .step-content h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--fg);
    margin-bottom: 4px;
  }
  .step-content p {
    font-size: 13px;
    color: var(--fg-dim);
    line-height: 1.5;
    margin-bottom: 8px;
  }
  .step-cmd {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    font-family: 'SF Mono', Menlo, monospace;
    font-size: 12px;
    color: var(--fg);
  }
  .step-cmd code { flex: 1; }
  .step-cmd .copy-btn {
    padding: 3px 8px;
    font-size: 10px;
  }
  .step-or {
    text-align: center;
    font-size: 12px;
    color: var(--fg-dim);
    opacity: 0.5;
    margin: -8px 0 12px 42px;
  }
  .hooks-status {
    text-align: center;
    margin-top: 16px;
    padding: 10px;
    border-radius: var(--radius-sm);
    font-size: 12px;
  }
  .hooks-status.installed {
    background: rgba(74, 222, 128, 0.1);
    color: var(--success);
    border: 1px solid rgba(74, 222, 128, 0.2);
  }
  .hooks-status.not-installed {
    background: rgba(251, 191, 36, 0.1);
    color: var(--warning);
    border: 1px solid rgba(251, 191, 36, 0.2);
  }

  /* ── Context & Intel Panel ── */
  .context-section-label {
    padding: 12px 16px 6px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--fg-dim);
    opacity: 0.6;
  }

  .context-file {
    display: flex;
    align-items: center;
    padding: 5px 16px;
    gap: 8px;
    font-size: 13px;
  }
  .context-file .cf-key {
    color: var(--fg-dim);
    font-family: 'SF Mono', Menlo, monospace;
    font-size: 11px;
    width: 18px;
    flex-shrink: 0;
  }
  .context-file .cf-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .context-file .cf-name.missing { color: var(--fg-dim); opacity: 0.5; }
  .context-file .cf-status {
    font-size: 11px;
    flex-shrink: 0;
  }

  .intel-row {
    display: flex;
    align-items: center;
    padding: 6px 16px;
    gap: 10px;
    font-size: 13px;
  }
  .intel-row .intel-label { flex: 1; }
  .intel-row .intel-age { color: var(--fg-dim); font-size: 12px; }
  .intel-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .intel-dot.fresh { background: var(--success); }
  .intel-dot.stale { background: var(--warning); }
  .intel-dot.old, .intel-dot.never { background: var(--error); opacity: 0.6; }

  /* ── Command Bar ── */
  .command-bar {
    display: flex;
    align-items: center;
    padding: 10px 20px;
    gap: 12px;
    border-top: 1px solid var(--border);
    background: var(--bg-panel);
    flex-shrink: 0;
  }
  .command-bar .prompt-char {
    color: var(--accent);
    font-size: 16px;
    font-weight: 700;
  }
  .command-bar input {
    flex: 1;
    background: none;
    border: none;
    color: var(--fg);
    font-size: 14px;
    font-family: inherit;
    outline: none;
  }
  .command-bar input::placeholder { color: var(--fg-dim); opacity: 0.5; }

  .quick-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
  }
  .quick-action {
    padding: 6px 14px;
    font-size: 12px;
    color: var(--fg-dim);
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    user-select: none;
  }
  .quick-action:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-glow);
  }
  .quick-action:active {
    transform: scale(0.96);
  }

  /* ── Toast ── */
  .toast-container {
    position: fixed;
    top: 60px;
    right: 20px;
    z-index: 200;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .toast {
    padding: 10px 18px;
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-weight: 500;
    color: white;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    animation: toastIn 0.3s ease;
    max-width: 360px;
  }
  .toast.success { background: #16a34a; }
  .toast.info { background: #2563eb; }
  .toast.warning { background: #d97706; }
  .toast.error { background: #dc2626; }
  .toast.fade-out { animation: toastOut 0.3s ease forwards; }
  @keyframes toastIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
  @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

  /* ── Launch Modal ── */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.hidden { display: none; }
  .modal {
    background: var(--bg-panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    width: 480px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .modal h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .modal .modal-sub {
    font-size: 13px;
    color: var(--fg-dim);
    margin-bottom: 16px;
  }
  .modal input {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--fg);
    font-size: 14px;
    outline: none;
    font-family: inherit;
  }
  .modal input:focus { border-color: var(--accent); }
  .modal-note {
    font-size: 12px;
    color: var(--fg-dim);
    margin-top: 10px;
    line-height: 1.5;
    opacity: 0.7;
  }
  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 16px;
  }
  .modal-actions button {
    padding: 8px 18px;
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--fg);
    transition: all 0.15s;
  }
  .modal-actions button:hover { border-color: var(--fg-dim); }
  .modal-actions .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }
  .modal-actions .btn-primary:hover { opacity: 0.85; }
  .modal-actions .btn-copy {
    background: var(--bg-card);
    border-color: var(--border);
    color: var(--fg);
  }
</style>
</head>
<body>

<!-- Status Bar -->
<div class="status-bar">
  <div class="title">MARKETING COMMAND CENTER</div>
  <div class="status-indicators">
    <div class="indicator"><div class="dot off" id="dot-onboard"></div><span>Onboarded</span></div>
    <div class="indicator"><div class="dot off" id="dot-intel"></div><span>Intel</span></div>
    <div class="indicator"><div class="dot off" id="dot-active"></div><span id="active-count">0</span> Active</div>
    <div class="indicator"><div class="dot off" id="dot-ws"></div><span>Connected</span></div>
  </div>
  <div class="status-right">
    <span id="session-id">No session</span>
    <span id="clock"></span>
  </div>
</div>

<!-- Main 3-Panel Layout -->
<div class="main">

  <!-- Left: Agent Panel -->
  <div class="panel">
    <div class="panel-header">Agents <span class="badge" id="agent-count">0</span></div>
    <div class="panel-body" id="agent-list"></div>
  </div>

  <!-- Center: Activity Stream -->
  <div class="panel" style="border-right: 1px solid var(--border);">
    <div class="panel-header">
      Activity Stream <span class="badge" id="event-count">0</span>
      <button class="clear-events-btn" id="clear-events-btn">Clear</button>
    </div>
    <div class="stream-filter hidden" id="stream-filter">
      <span class="filter-label" id="filter-label"></span>
      <button class="clear-btn" id="clear-filter-btn">Clear</button>
    </div>
    <div class="panel-body" id="event-list"></div>
  </div>

  <!-- Right: Context & Intel -->
  <div class="panel">
    <div class="panel-header">Context & Intel</div>
    <div class="panel-body">
      <div class="context-section-label">Context Files</div>
      <div id="context-files"></div>
      <div class="context-section-label" style="margin-top: 8px;">Intelligence Status</div>
      <div id="intel-status"></div>
    </div>
  </div>

</div>

<!-- Command Bar -->
<div class="command-bar">
  <span class="prompt-char">&#x276F;</span>
  <input type="text" id="command-input" placeholder="Type a command (/cmo, /analyst, /onboard) and press Enter..." autocomplete="off">
  <div class="quick-actions" id="quick-actions">
    <button class="quick-action" data-cmd="/cmo">/cmo</button>
    <button class="quick-action" data-cmd="/analyst">/analyst</button>
    <button class="quick-action" data-cmd="/onboard">/onboard</button>
  </div>
</div>

<!-- Launch Modal -->
<div class="modal-overlay hidden" id="launch-modal">
  <div class="modal">
    <h3 id="modal-title">Launch Agent</h3>
    <div class="modal-sub" id="modal-sub">Enter a task description</div>
    <input type="text" id="modal-input" placeholder="e.g. Plan February content calendar...">
    <div class="modal-note">The agent will run in the background. Activity appears in the stream when hooks are installed.</div>
    <div class="modal-actions">
      <button id="modal-copy-btn" class="btn-copy">Copy Command</button>
      <button id="modal-cancel-btn">Cancel</button>
      <button id="modal-launch-btn" class="btn-primary">Launch</button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<script>
// ── State ──
let agents = [];
let events = [];
let agentStatuses = new Map();
let filterAgentType = null;
let selectedAgentName = null;
let launchTarget = null;
let ws = null;
let wsConnected = false;
let hooksInstalled = false;

const COLORS = {
  blue: '#3b82f6', green: '#22c55e', purple: '#a855f7', pink: '#ec4899',
  red: '#ef4444', cyan: '#06b6d4', orange: '#f97316', amber: '#f59e0b',
};

const EVENT_BADGES = {
  SubagentStart:     { sym: '\u25B6', label: 'SPAWN', color: 'var(--success)' },
  SubagentStop:      { sym: '\u25A0', label: 'STOP',  color: 'var(--fg-dim)' },
  PreToolUse:        { sym: '\u2192', label: 'TOOL',  color: 'var(--warning)' },
  PostToolUse:       { sym: '\u2713', label: 'DONE',  color: 'var(--info)' },
  PostToolUseFailure:{ sym: '\u2717', label: 'FAIL',  color: 'var(--error)' },
  Stop:              { sym: '\u25FC', label: 'END',   color: 'var(--fg-dim)' },
  SessionStart:      { sym: '\u25CF', label: 'START', color: 'var(--success)' },
  SessionEnd:        { sym: '\u25CB', label: 'END',   color: 'var(--fg-dim)' },
};

// ── Toast System ──
function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add('fade-out');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ── Clipboard ──
async function copyToClipboard(text) {
  try {
    await navigator.clipboard.writeText(text);
    showToast('Copied to clipboard', 'success');
  } catch {
    showToast('Copy failed - use manual copy', 'warning');
  }
}

// ── Init ──
async function init() {
  updateClock();
  setInterval(updateClock, 1000);

  const [agentData, intelData, eventData] = await Promise.all([
    fetch('/api/agents').then(r => r.json()).catch(() => []),
    fetch('/api/intel').then(r => r.json()).catch(() => ({})),
    fetch('/events?limit=200').then(r => r.json()).catch(() => []),
  ]);

  agents = agentData;
  hooksInstalled = eventData.length > 0;

  renderAgents();
  renderIntel(intelData);

  for (const e of eventData) {
    processAgentStatus(e);
    events.push(e);
  }
  renderEvents();
  updateStatusBar(intelData);

  const lastStart = [...eventData].reverse().find(e => e.hook_event_name === 'SessionStart');
  if (lastStart?.session_id) {
    document.getElementById('session-id').textContent = lastStart.session_id.slice(0, 8);
  }

  connectWebSocket();
  bindEvents();

  document.getElementById('agent-count').textContent = agents.length;
}

// ── Event Binding (no inline onclick) ──
function bindEvents() {
  // Command input
  const input = document.getElementById('command-input');
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && input.value.trim()) {
      handleCommand(input.value.trim());
      input.value = '';
    }
  });

  // Quick action buttons
  document.getElementById('quick-actions').addEventListener('click', (e) => {
    const btn = e.target.closest('[data-cmd]');
    if (btn) {
      const cmd = btn.dataset.cmd;
      const name = cmd.slice(1);
      const agent = agents.find(a => a.name === name);
      if (agent) openLaunchModal(agent.name);
    }
  });

  // Agent list (delegated)
  document.getElementById('agent-list').addEventListener('click', (e) => {
    const row = e.target.closest('[data-agent]');
    if (!row) return;
    const name = row.dataset.agent;
    selectAgent(name);
  });
  document.getElementById('agent-list').addEventListener('dblclick', (e) => {
    const row = e.target.closest('[data-agent]');
    if (!row) return;
    openLaunchModal(row.dataset.agent);
  });

  // Copy buttons (delegated on agent list)
  document.getElementById('agent-list').addEventListener('click', (e) => {
    const copyBtn = e.target.closest('[data-copy]');
    if (copyBtn) {
      e.stopPropagation();
      copyToClipboard(copyBtn.dataset.copy);
    }
  });

  // Clear events
  document.getElementById('clear-events-btn').addEventListener('click', () => {
    events = [];
    agentStatuses.clear();
    renderEvents();
    renderAgents();
    updateActiveCount();
    showToast('Events cleared', 'info');
  });

  // Filter clear
  document.getElementById('clear-filter-btn').addEventListener('click', clearFilter);

  // Modal buttons
  document.getElementById('modal-cancel-btn').addEventListener('click', closeLaunchModal);
  document.getElementById('modal-launch-btn').addEventListener('click', confirmLaunch);
  document.getElementById('modal-copy-btn').addEventListener('click', () => {
    if (!launchTarget) return;
    const task = document.getElementById('modal-input').value.trim() || 'Begin session';
    const cmd = launchTarget.isOrchestrator
      ? `claude /${launchTarget.name} ${task}`
      : `claude --agent ${launchTarget.filePath} --prompt "${task}"`;
    copyToClipboard(cmd);
    closeLaunchModal();
  });

  // Modal input enter/escape
  document.getElementById('modal-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') confirmLaunch();
    if (e.key === 'Escape') closeLaunchModal();
  });

  // Global escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLaunchModal();
  });

  // Modal overlay click-to-close
  document.getElementById('launch-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) closeLaunchModal();
  });
}

// ── WebSocket ──
function connectWebSocket() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/events/stream`);

  ws.onopen = () => {
    wsConnected = true;
    document.getElementById('dot-ws').className = 'dot on pulse';
  };
  ws.onclose = () => {
    wsConnected = false;
    document.getElementById('dot-ws').className = 'dot off';
    setTimeout(connectWebSocket, 3000);
  };
  ws.onmessage = (msg) => {
    try {
      const event = JSON.parse(msg.data);
      hooksInstalled = true;
      processAgentStatus(event);
      events.push(event);
      if (events.length > 300) events = events.slice(-200);
      renderEvents();
      updateActiveCount();

      if (event.hook_event_name === 'SessionStart' && event.session_id) {
        document.getElementById('session-id').textContent = event.session_id.slice(0, 8);
        showToast('New session started', 'success');
      }
      if (event.hook_event_name === 'SubagentStart') {
        showToast(`Agent spawned: ${event.agent_type || 'unknown'}`, 'info');
      }
    } catch {}
  };
}

// ── Agent Status Tracking ──
function processAgentStatus(event) {
  const { hook_event_name, agent_id, agent_type, parent_session_id, received_at, tool_name } = event;

  if (hook_event_name === 'SubagentStart' && agent_id) {
    agentStatuses.set(agent_id, {
      agentType: agent_type || 'unknown',
      status: 'active',
      startedAt: received_at || new Date().toISOString(),
      parentSessionId: parent_session_id || null,
      toolCounts: {},
      totalTools: 0,
    });
    renderAgents();
  } else if (hook_event_name === 'SubagentStop' && agent_id) {
    const s = agentStatuses.get(agent_id);
    if (s) { s.status = 'idle'; agentStatuses.set(agent_id, s); renderAgents(); }
  } else if ((hook_event_name === 'PostToolUse' || hook_event_name === 'PostToolUseFailure') && agent_id && tool_name) {
    const s = agentStatuses.get(agent_id);
    if (s) {
      s.toolCounts[tool_name] = (s.toolCounts[tool_name] || 0) + 1;
      s.totalTools++;
      agentStatuses.set(agent_id, s);
    }
  }
}

function getActiveCount() {
  return [...agentStatuses.values()].filter(s => s.status === 'active').length;
}

function updateActiveCount() {
  const count = getActiveCount();
  document.getElementById('active-count').textContent = count;
  document.getElementById('dot-active').className = count > 0 ? 'dot on pulse' : 'dot off';
}

function isAgentActive(agentName) {
  for (const [, s] of agentStatuses) {
    if (s.agentType === agentName && s.status === 'active') return true;
  }
  return false;
}

// ── Renderers ──
function renderAgents() {
  const list = document.getElementById('agent-list');

  const childrenOf = {};
  for (const [, s] of agentStatuses) {
    if (s.parentSessionId && s.status === 'active') {
      for (const [pid, ps] of agentStatuses) {
        if (pid === s.parentSessionId) {
          const key = ps.agentType;
          if (!childrenOf[key]) childrenOf[key] = [];
          if (!childrenOf[key].includes(s.agentType)) childrenOf[key].push(s.agentType);
        }
      }
    }
  }

  const orchs = agents.filter(a => a.isOrchestrator);
  const specs = agents.filter(a => !a.isOrchestrator);

  let html = '<div class="agent-section-label">Orchestrators</div>';
  for (const a of orchs) {
    html += agentRowHTML(a);
    if (selectedAgentName === a.name) html += agentDetailHTML(a);
    if (childrenOf[a.name]) {
      for (let i = 0; i < childrenOf[a.name].length; i++) {
        const childType = childrenOf[a.name][i];
        const childAgent = specs.find(s => s.name === childType);
        if (childAgent) {
          const isLast = i === childrenOf[a.name].length - 1;
          html += agentRowHTML(childAgent, true, isLast ? '\u2514' : '\u251C');
        }
      }
    }
  }

  html += '<div class="agent-section-label" style="margin-top: 4px;">Specialists</div>';
  for (const a of specs) {
    html += agentRowHTML(a);
    if (selectedAgentName === a.name) html += agentDetailHTML(a);
  }

  list.innerHTML = html;
}

function agentRowHTML(agent, spawned = false, connector = '') {
  const active = isAgentActive(agent.name);
  const color = COLORS[agent.color] || 'var(--fg-dim)';
  const selected = selectedAgentName === agent.name;
  const cls = ['agent-row'];
  if (selected) cls.push('selected');
  if (spawned) cls.push('spawned');

  let connectorHtml = '';
  if (spawned) {
    connectorHtml = `<span class="tree-connector">${connector}</span>`;
  }

  return `<div class="${cls.join(' ')}" data-agent="${agent.name}">
    ${connectorHtml}
    <div class="agent-color-dot" style="background:${color}"></div>
    <div class="agent-name">${agent.displayName}</div>
    <span class="agent-hotkey">${agent.hotkey}</span>
    <div class="agent-status ${active ? 'active' : 'idle'}"></div>
  </div>`;
}

function agentDetailHTML(agent) {
  const desc = agent.description || 'No description';
  const cmd = agent.isOrchestrator
    ? `/${agent.name}`
    : `claude --agent .claude/agents/${agent.name}.md`;

  return `<div class="agent-detail">
    <div class="detail-desc">${escapeHtml(desc)}</div>
    <div class="copy-cmd">
      <code>${escapeHtml(cmd)}</code>
      <button class="copy-btn" data-copy="${escapeHtml(cmd)}">Copy</button>
    </div>
  </div>`;
}

function renderEvents() {
  const list = document.getElementById('event-list');
  const filtered = filterAgentType
    ? events.filter(e => e.agent_type === filterAgentType)
    : events;

  document.getElementById('event-count').textContent = filtered.length;

  if (filtered.length === 0) {
    list.innerHTML = renderEmptyState();
    return;
  }

  let html = '';
  for (const event of filtered.slice(-150)) {
    html += eventCardHTML(event);
  }
  list.innerHTML = html;
  list.scrollTop = list.scrollHeight;
}

function renderEmptyState() {
  return `<div class="getting-started">
    <h2>Getting Started</h2>

    <div class="step">
      <div class="step-num">1</div>
      <div class="step-content">
        <h3>Install event hooks</h3>
        <p>Connect Claude Code sessions to this dashboard so agent activity streams here in real-time.</p>
        <div class="step-cmd">
          <code>cd command-center && bash hooks/install.sh</code>
          <button class="copy-btn" data-copy="cd command-center && bash hooks/install.sh">Copy</button>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">2</div>
      <div class="step-content">
        <h3>Run a Claude session in your terminal</h3>
        <p>Open a terminal and start any Claude command. The dashboard monitors your sessions - it doesn't replace them.</p>
        <div class="step-cmd">
          <code>claude /cmo</code>
          <button class="copy-btn" data-copy="claude /cmo">Copy</button>
        </div>
        <div style="height:6px"></div>
        <div class="step-cmd">
          <code>claude /analyst</code>
          <button class="copy-btn" data-copy="claude /analyst">Copy</button>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">3</div>
      <div class="step-content">
        <h3>Watch activity appear here</h3>
        <p>Every tool call, agent spawn, and session event streams to this dashboard via WebSocket. See all your agents working simultaneously.</p>
      </div>
    </div>

    <div class="hooks-status ${hooksInstalled ? 'installed' : 'not-installed'}">
      ${hooksInstalled
        ? 'Hooks connected - waiting for new events...'
        : 'No events received yet. Run step 1 to install hooks.'}
    </div>
  </div>`;
}

function eventCardHTML(event) {
  const badge = EVENT_BADGES[event.hook_event_name] || { sym: '\u00B7', label: event.hook_event_name || '?', color: 'var(--fg-dim)' };
  const agent = agents.find(a => a.name === event.agent_type);
  const color = agent ? (COLORS[agent.color] || 'var(--fg-dim)') : 'var(--fg-dim)';
  const tag = agent ? agent.shortTag : (event.agent_type || '?').split('-')[0].slice(0, 6);
  const time = formatTime(event.received_at);
  const context = getEventContext(event);
  const indent = event.parent_session_id ? 'event-indent-1' : '';
  const multiAgent = getActiveCount() > 1 || agentStatuses.size > 1;

  return `<div class="event-card ${indent}">
    <div class="event-stripe" style="background:${color}"></div>
    <div class="event-body">
      <div class="event-top">
        ${multiAgent ? `<span class="event-agent-tag" style="background:${color}22;color:${color}">${tag}</span>` : ''}
        <span class="event-time">${time}</span>
        <span class="event-badge" style="color:${badge.color}">${badge.sym} ${badge.label}</span>
      </div>
      ${context ? `<div class="event-context">${escapeHtml(context)}</div>` : ''}
    </div>
  </div>`;
}

function getEventContext(event) {
  try {
    const p = event.payload ? JSON.parse(event.payload) : {};
    const ti = p.tool_input || p.input || {};
    const tn = event.tool_name || '';

    if (['SubagentStart', 'SubagentStop'].includes(event.hook_event_name)) {
      return event.agent_type || p.agent_type || '';
    }

    switch (tn) {
      case 'Bash': return ti.command ? ti.command.slice(0, 80) : '';
      case 'Read': return shortPath(ti.file_path || '');
      case 'Write': case 'Edit': return shortPath(ti.file_path || '');
      case 'Glob': return ti.pattern || '';
      case 'Grep': return ti.pattern || '';
      case 'WebFetch': return extractDomain(ti.url || '');
      case 'WebSearch': return ti.query ? ti.query.slice(0, 50) : '';
      case 'Task': return ti.description ? ti.description.slice(0, 50) : '';
      default: return tn;
    }
  } catch { return event.tool_name || ''; }
}

function renderIntel(data) {
  if (!data || !data.intel) return;

  const cfDiv = document.getElementById('context-files');
  cfDiv.innerHTML = (data.contextFiles || []).map(cf =>
    `<div class="context-file">
      <span class="cf-key">${cf.key}</span>
      <span class="cf-name ${cf.exists ? '' : 'missing'}">${cf.label}</span>
      <span class="cf-status">${cf.exists ? '\u2713' : '\u2717'}</span>
    </div>`
  ).join('');

  const intelDiv = document.getElementById('intel-status');
  let html = '';
  for (const item of data.intel.items) {
    html += `<div class="intel-row">
      <span class="intel-label">${item.label}</span>
      <span class="intel-age">${item.displayLabel}</span>
      <div class="intel-dot ${item.status}"></div>
    </div>`;
  }
  html += `<div class="intel-row">
    <span class="intel-label">Ledger</span>
    <span class="intel-age">${data.intel.ledgerCount} sessions</span>
    <div class="intel-dot ${data.intel.ledgerCount > 0 ? 'fresh' : 'never'}"></div>
  </div>`;
  intelDiv.innerHTML = html;
}

function updateStatusBar(intelData) {
  if (intelData) {
    document.getElementById('dot-onboard').className = intelData.isOnboarded ? 'dot on' : 'dot off';
    const hasFresh = (intelData.intel?.items || []).some(i => i.status === 'fresh');
    document.getElementById('dot-intel').className = hasFresh ? 'dot on' : 'dot warn';
  }
  updateActiveCount();
}

// ── Agent Selection & Filtering ──
function selectAgent(name) {
  selectedAgentName = selectedAgentName === name ? null : name;
  renderAgents();
}

function setFilter(agentType) {
  filterAgentType = agentType;
  document.getElementById('stream-filter').classList.remove('hidden');
  document.getElementById('filter-label').textContent = `Filtered: ${agentType}`;
  renderEvents();
}

function clearFilter() {
  filterAgentType = null;
  document.getElementById('stream-filter').classList.add('hidden');
  renderEvents();
}

// ── Launch Modal ──
function openLaunchModal(agentName) {
  const agent = agents.find(a => a.name === agentName);
  if (!agent) return;
  launchTarget = agent;
  document.getElementById('modal-title').textContent = `Launch ${agent.displayName}`;
  document.getElementById('modal-sub').textContent = agent.description || 'Enter a task description';
  document.getElementById('modal-input').value = '';
  document.getElementById('launch-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('modal-input').focus(), 50);
}

function closeLaunchModal() {
  document.getElementById('launch-modal').classList.add('hidden');
  launchTarget = null;
}

async function confirmLaunch() {
  const task = document.getElementById('modal-input').value.trim();
  if (!task || !launchTarget) {
    if (!task) showToast('Enter a task description first', 'warning');
    return;
  }

  try {
    const res = await fetch('/api/launch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentFile: launchTarget.filePath, task }),
    });
    const data = await res.json();
    if (data.ok) {
      showToast(`${launchTarget.displayName} launched (PID: ${data.pid})`, 'success');
    } else {
      showToast(`Launch failed: ${data.error || 'unknown'}`, 'error');
    }
  } catch (e) {
    showToast('Launch failed: ' + e.message, 'error');
  }
  closeLaunchModal();
}

// ── Command Bar ──
function handleCommand(input) {
  if (input.startsWith('/')) {
    const parts = input.split(' ');
    const cmd = parts[0].slice(1);
    const agent = agents.find(a => a.name === cmd);
    if (agent) {
      openLaunchModal(agent.name);
      if (parts.length > 1) {
        setTimeout(() => {
          document.getElementById('modal-input').value = parts.slice(1).join(' ');
        }, 100);
      }
      return;
    }
    showToast(`Unknown command: ${parts[0]}`, 'warning');
  } else {
    showToast('Commands start with / (e.g. /cmo, /analyst)', 'info');
  }
}

// ── Helpers ──
function formatTime(ts) {
  if (!ts) return '--:--:--';
  try {
    const d = new Date(ts);
    return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  } catch { return '--:--:--'; }
}

function shortPath(p) {
  if (!p) return '';
  const parts = p.split('/');
  return parts.length > 2 ? parts.slice(-2).join('/') : p;
}

function extractDomain(url) {
  try { return new URL(url).hostname; } catch { return url.slice(0, 30); }
}

function escapeHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function updateClock() {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

// ── Go ──
init();
</script>
</body>
</html>
