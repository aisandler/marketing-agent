<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Engine Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard-content {
            padding: 30px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 5px solid #3498db;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .metric-card.success {
            border-left-color: #27ae60;
        }

        .metric-card.warning {
            border-left-color: #f39c12;
        }

        .metric-card.danger {
            border-left-color: #e74c3c;
        }

        .metric-title {
            font-size: 0.9em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .metric-subtitle {
            font-size: 0.85em;
            color: #95a5a6;
        }

        .metric-trend {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
            margin-top: 8px;
        }

        .trend-up {
            background: #d5f4e6;
            color: #27ae60;
        }

        .trend-down {
            background: #fadbd8;
            color: #e74c3c;
        }

        .trend-stable {
            background: #e8f4f8;
            color: #3498db;
        }

        .charts-section {
            margin-top: 40px;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .chart-placeholder {
            height: 300px;
            background: linear-gradient(45deg, #f1f2f6 25%, transparent 25%),
                        linear-gradient(-45deg, #f1f2f6 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f1f2f6 75%),
                        linear-gradient(-45deg, transparent 75%, #f1f2f6 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            font-size: 1.1em;
            border: 2px dashed #bdc3c7;
        }

        .alerts-section {
            margin-top: 40px;
        }

        .alerts-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .alert-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .alert-item.high {
            border-left-color: #e74c3c;
        }

        .alert-item.medium {
            border-left-color: #f39c12;
        }

        .alert-item.low {
            border-left-color: #3498db;
        }

        .alert-content {
            flex: 1;
        }

        .alert-message {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .alert-details {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .alert-severity {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-high {
            background: #fadbd8;
            color: #e74c3c;
        }

        .severity-medium {
            background: #fef5e7;
            color: #f39c12;
        }

        .severity-low {
            background: #e8f4f8;
            color: #3498db;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-button {
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .control-button.secondary {
            background: #95a5a6;
        }

        .control-button.secondary:hover {
            background: #7f8c8d;
        }

        .date-selector {
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .dashboard-content {
                padding: 20px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .controls {
                flex-direction: column;
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Marketing Engine Analytics</h1>
            <p>Performance monitoring and quality metrics dashboard</p>
        </div>

        <div class="dashboard-content">
            <div class="controls">
                <button class="control-button" onclick="refreshMetrics()">üîÑ Refresh Data</button>
                <button class="control-button secondary" onclick="runHealthCheck()">üè• Health Check</button>
                <button class="control-button secondary" onclick="generateReport()">üìä Generate Report</button>
                <input type="date" class="date-selector" id="dateSelector" onchange="loadMetricsForDate()">
                <button class="control-button secondary" onclick="viewAlerts()">üö® View Alerts</button>
            </div>

            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Loading analytics data...</p>
            </div>

            <div id="metricsContainer" class="metrics-grid" style="display: none;">
                <!-- Metrics cards will be populated here -->
            </div>

            <div id="chartsSection" class="charts-section" style="display: none;">
                <div class="chart-container">
                    <h3 class="chart-title">Performance Trends</h3>
                    <div class="chart-placeholder">
                        üìà Performance trend charts will be implemented with Chart.js integration
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Content Generation Analysis</h3>
                    <div class="chart-placeholder">
                        üìä Content generation analytics visualization
                    </div>
                </div>
            </div>

            <div id="alertsSection" class="alerts-section" style="display: none;">
                <div class="alerts-container">
                    <h3 class="chart-title">üö® Recent Alerts</h3>
                    <div id="alertsContainer">
                        <!-- Alerts will be populated here -->
                    </div>
                </div>
            </div>

            <div id="noDataMessage" class="no-data" style="display: none;">
                <h3>No Data Available</h3>
                <p>Start generating content to see analytics data here.</p>
                <button class="control-button" onclick="initializeMetrics()">Initialize Metrics System</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentMetrics = null;
        let systemHealth = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            setTodayDate();
            loadInitialData();
        });

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateSelector').value = today;
        }

        async function loadInitialData() {
            try {
                await refreshMetrics();
                await runHealthCheck();
            } catch (error) {
                console.error('Error loading initial data:', error);
                showNoData();
            }
        }

        async function refreshMetrics() {
            showLoading();

            try {
                const selectedDate = document.getElementById('dateSelector').value;
                const response = await executeCommand('metrics', selectedDate);

                if (response && response.metrics) {
                    currentMetrics = response;
                    displayMetrics(response);
                    showMetrics();
                } else {
                    showNoData();
                }
            } catch (error) {
                console.error('Error refreshing metrics:', error);
                showNoData();
            }
        }

        async function runHealthCheck() {
            try {
                const health = await executeCommand('health');
                systemHealth = health;
                console.log('System health updated:', health);
            } catch (error) {
                console.error('Error running health check:', error);
            }
        }

        async function loadMetricsForDate() {
            await refreshMetrics();
        }

        async function generateReport() {
            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;

                const report = await executeCommand('report', year, month);

                if (report) {
                    displayReport(report);
                } else {
                    alert('No data available for monthly report');
                }
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Error generating report');
            }
        }

        async function viewAlerts() {
            try {
                const alerts = await executeCommand('alerts');
                displayAlerts(alerts);
                document.getElementById('alertsSection').style.display = 'block';
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        async function initializeMetrics() {
            try {
                // Initialize with some sample events
                await executeCommand('record', 'content_generation_start');
                await executeCommand('record', 'content_generation_success', JSON.stringify({
                    duration: 45,
                    tokens: 2500
                }));

                alert('Metrics system initialized! Generate some content to see data.');
                await refreshMetrics();
            } catch (error) {
                console.error('Error initializing metrics:', error);
                alert('Error initializing metrics system');
            }
        }

        function displayMetrics(data) {
            const container = document.getElementById('metricsContainer');
            const metrics = data.metrics;

            container.innerHTML = `
                <div class="metric-card ${getCardClass(metrics.success_rate, 90)}">
                    <div class="metric-title">Generation Success Rate</div>
                    <div class="metric-value">${metrics.success_rate}%</div>
                    <div class="metric-subtitle">Target: >95%</div>
                    <span class="metric-trend ${getTrendClass(metrics.success_rate, 90)}">${getTrendText(metrics.success_rate, 90)}</span>
                </div>

                <div class="metric-card ${getCardClass(metrics.avg_generation_time, 120, true)}">
                    <div class="metric-title">Avg Generation Time</div>
                    <div class="metric-value">${metrics.avg_generation_time}s</div>
                    <div class="metric-subtitle">Target: <120s</div>
                    <span class="metric-trend ${getTrendClass(metrics.avg_generation_time, 120, true)}">${getTrendText(metrics.avg_generation_time, 120, true)}</span>
                </div>

                <div class="metric-card ${getCardClass(metrics.avg_token_usage, 4000, true)}">
                    <div class="metric-title">Avg Token Usage</div>
                    <div class="metric-value">${metrics.avg_token_usage}</div>
                    <div class="metric-subtitle">Target: <4000</div>
                    <span class="metric-trend ${getTrendClass(metrics.avg_token_usage, 4000, true)}">${getTrendText(metrics.avg_token_usage, 4000, true)}</span>
                </div>

                <div class="metric-card ${getCardClass(metrics.error_rate, 5, true)}">
                    <div class="metric-title">Error Rate</div>
                    <div class="metric-value">${metrics.error_rate}%</div>
                    <div class="metric-subtitle">Target: <5%</div>
                    <span class="metric-trend ${getTrendClass(metrics.error_rate, 5, true)}">${getTrendText(metrics.error_rate, 5, true)}</span>
                </div>

                <div class="metric-card ${getCardClass(metrics.validation_pass_rate, 80)}">
                    <div class="metric-title">Validation Pass Rate</div>
                    <div class="metric-value">${metrics.validation_pass_rate}%</div>
                    <div class="metric-subtitle">Target: >90%</div>
                    <span class="metric-trend ${getTrendClass(metrics.validation_pass_rate, 80)}">${getTrendText(metrics.validation_pass_rate, 80)}</span>
                </div>

                <div class="metric-card ${getCardClass(metrics.approval_rate, 60)}">
                    <div class="metric-title">Content Approval Rate</div>
                    <div class="metric-value">${metrics.approval_rate}%</div>
                    <div class="metric-subtitle">Target: >80%</div>
                    <span class="metric-trend ${getTrendClass(metrics.approval_rate, 60)}">${getTrendText(metrics.approval_rate, 60)}</span>
                </div>

                <div class="metric-card">
                    <div class="metric-title">Content Velocity</div>
                    <div class="metric-value">${metrics.content_velocity}</div>
                    <div class="metric-subtitle">Pieces generated today</div>
                    <span class="metric-trend trend-stable">Daily Output</span>
                </div>

                <div class="metric-card ${getCardClass(metrics.duplicate_rate, 15, true)}">
                    <div class="metric-title">Duplicate Rate</div>
                    <div class="metric-value">${metrics.duplicate_rate}%</div>
                    <div class="metric-subtitle">Target: <5%</div>
                    <span class="metric-trend ${getTrendClass(metrics.duplicate_rate, 15, true)}">${getTrendText(metrics.duplicate_rate, 15, true)}</span>
                </div>
            `;
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alertsContainer');

            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="no-data"><p>No recent alerts</p></div>';
                return;
            }

            container.innerHTML = alerts.map(alert => `
                <div class="alert-item ${alert.severity}">
                    <div class="alert-content">
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-details">
                            Type: ${alert.type} | Value: ${alert.value} | Threshold: ${alert.threshold}
                            <br>Time: ${new Date(alert.timestamp).toLocaleString()}
                        </div>
                    </div>
                    <div class="alert-severity severity-${alert.severity}">${alert.severity}</div>
                </div>
            `).join('');
        }

        function displayReport(report) {
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <html>
                <head>
                    <title>Monthly Report - ${report.period}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .summary { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        .metric { margin: 10px 0; }
                        .alerts { background: #fff3cd; padding: 15px; border-radius: 8px; }
                    </style>
                </head>
                <body>
                    <h1>Monthly Performance Report - ${report.period}</h1>
                    <div class="summary">
                        <h2>Summary</h2>
                        <div class="metric"><strong>Total Generations:</strong> ${report.summary.total_generations}</div>
                        <div class="metric"><strong>Success Rate:</strong> ${report.summary.overall_success_rate}</div>
                        <div class="metric"><strong>Average Generation Time:</strong> ${report.summary.avg_generation_time}</div>
                        <div class="metric"><strong>Error Rate:</strong> ${report.summary.error_rate}</div>
                        <div class="metric"><strong>Validation Pass Rate:</strong> ${report.summary.validation_pass_rate}</div>
                        <div class="metric"><strong>Approval Rate:</strong> ${report.summary.approval_rate}</div>
                    </div>
                    <div class="alerts">
                        <h2>Alerts Summary</h2>
                        <div class="metric"><strong>Total Alerts:</strong> ${report.alerts_summary.total_alerts}</div>
                        <div class="metric"><strong>High Severity:</strong> ${report.alerts_summary.high_severity}</div>
                        <div class="metric"><strong>Medium Severity:</strong> ${report.alerts_summary.medium_severity}</div>
                    </div>
                </body>
                </html>
            `);
        }

        // Utility functions
        function getCardClass(value, threshold, isReverse = false) {
            const numValue = parseFloat(value);
            if (isReverse) {
                return numValue <= threshold ? 'success' : numValue <= threshold * 1.5 ? 'warning' : 'danger';
            } else {
                return numValue >= threshold ? 'success' : numValue >= threshold * 0.8 ? 'warning' : 'danger';
            }
        }

        function getTrendClass(value, threshold, isReverse = false) {
            const numValue = parseFloat(value);
            if (isReverse) {
                return numValue <= threshold ? 'trend-up' : 'trend-down';
            } else {
                return numValue >= threshold ? 'trend-up' : 'trend-down';
            }
        }

        function getTrendText(value, threshold, isReverse = false) {
            const numValue = parseFloat(value);
            if (isReverse) {
                return numValue <= threshold ? 'Good' : 'Needs Attention';
            } else {
                return numValue >= threshold ? 'Good' : 'Needs Attention';
            }
        }

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('metricsContainer').style.display = 'none';
            document.getElementById('chartsSection').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
        }

        function showMetrics() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('metricsContainer').style.display = 'grid';
            document.getElementById('chartsSection').style.display = 'block';
            document.getElementById('noDataMessage').style.display = 'none';
        }

        function showNoData() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('metricsContainer').style.display = 'none';
            document.getElementById('chartsSection').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'block';
        }

        // Command execution function
        async function executeCommand(command, ...args) {
            const baseUrl = 'http://localhost:3002/api';
            const endpoint = `${baseUrl}/metrics/${command}`;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ args: args })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed, attempting direct execution:', error);

                // Fallback: try to load data directly from files
                if (command === 'metrics') {
                    return await loadMetricsFromFile(args[0]);
                }

                throw error;
            }
        }

        async function loadMetricsFromFile(date) {
            try {
                const response = await fetch('/metrics/metrics-data.json');
                if (!response.ok) return null;

                const data = await response.json();
                const targetDate = date || new Date().toISOString().split('T')[0];
                const dailyData = data.daily_metrics[targetDate];

                if (!dailyData) return null;

                // Calculate metrics similar to performance-tracker.js
                const metrics = {
                    success_rate: dailyData.generation_attempts > 0
                        ? (dailyData.generation_successes / dailyData.generation_attempts * 100).toFixed(2)
                        : '0',
                    avg_generation_time: dailyData.generation_times.length > 0
                        ? (dailyData.generation_times.reduce((a, b) => a + b, 0) / dailyData.generation_times.length).toFixed(2)
                        : '0',
                    avg_token_usage: dailyData.token_usage.length > 0
                        ? Math.round(dailyData.token_usage.reduce((a, b) => a + b, 0) / dailyData.token_usage.length)
                        : 0,
                    error_rate: dailyData.generation_attempts > 0
                        ? (dailyData.generation_errors / dailyData.generation_attempts * 100).toFixed(2)
                        : '0',
                    validation_pass_rate: (dailyData.validation_passes + dailyData.validation_failures) > 0
                        ? (dailyData.validation_passes / (dailyData.validation_passes + dailyData.validation_failures) * 100).toFixed(2)
                        : '0',
                    approval_rate: (dailyData.content_approvals + dailyData.content_rejections) > 0
                        ? (dailyData.content_approvals / (dailyData.content_approvals + dailyData.content_rejections) * 100).toFixed(2)
                        : '0',
                    duplicate_rate: dailyData.generation_successes > 0
                        ? (dailyData.duplicates_detected / dailyData.generation_successes * 100).toFixed(2)
                        : '0',
                    content_velocity: dailyData.generation_successes
                };

                return { date: targetDate, metrics: metrics, raw_data: dailyData };
            } catch (error) {
                console.error('Error loading metrics from file:', error);
                return null;
            }
        }

        // Auto-refresh every 5 minutes
        setInterval(refreshMetrics, 5 * 60 * 1000);
    </script>
</body>
</html>